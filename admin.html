<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>管理后台 - 快手转发工具</title>
    <style>
        :root {
            --primary: #ff6b6b;
            --secondary: #4ecdc4;
            --dark: #2f3542;
            --light: #f1f2f6;
            --gray: #a4b0be;
            --success: #2ed573;
            --warning: #ffa502;
            --error: #ff4757;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Arial, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #1e3c72, #2a5298);
            color: white;
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            width: 100%;
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(10px);
            display: none;
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .header h1 {
            font-size: 32px;
            margin-bottom: 10px;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            font-weight: 700;
        }
        
        .header p {
            color: var(--gray);
            font-size: 16px;
        }
        
        .dashboard {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .panel {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 10px;
            padding: 20px;
        }
        
        .panel h2 {
            margin-bottom: 15px;
            color: var(--secondary);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            padding-bottom: 10px;
        }
        
        .input-group {
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
        }
        
        input, textarea, select {
            width: 100%;
            padding: 12px;
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            background: rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 16px;
        }
        
        textarea {
            min-height: 100px;
            resize: vertical;
        }
        
        input::placeholder, textarea::placeholder {
            color: rgba(255, 255, 255, 0.6);
        }
        
        .input-row {
            display: flex;
            gap: 15px;
        }
        
        .input-row .input-group {
            flex: 1;
        }
        
        .button-group {
            display: flex;
            gap: 15px;
            margin-top: 20px;
        }
        
        button {
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            transition: 0.3s;
            font-size: 16px;
        }
        
        .primary-btn {
            background: var(--primary);
            color: white;
        }
        
        .primary-btn:hover:not(:disabled) {
            background: #ff5252;
            transform: translateY(-2px);
        }
        
        .primary-btn:disabled {
            background: var(--gray);
            cursor: not-allowed;
        }
        
        .secondary-btn {
            background: rgba(255, 255, 255, 0.1);
            color: var(--light);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .secondary-btn:hover:not(:disabled) {
            background: rgba(255, 255, 255, 0.15);
        }
        
        .keys-list {
            margin-top: 20px;
        }
        
        .keys-list h3 {
            margin-bottom: 10px;
            color: var(--secondary);
        }
        
        .keys-container {
            max-height: 300px;
            overflow-y: auto;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
            padding: 15px;
        }
        
        .key-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .key-item:last-child {
            border-bottom: none;
        }
        
        .key-info {
            flex: 1;
        }
        
        .key-value {
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .key-details {
            font-size: 12px;
            color: var(--gray);
        }
        
        .key-actions {
            display: flex;
            gap: 10px;
        }
        
        .delete-btn {
            background: var(--error);
            color: white;
            padding: 5px 10px;
            font-size: 12px;
        }
        
        .system-info {
            margin-top: 20px;
        }
        
        .system-info h3 {
            margin-bottom: 10px;
            color: var(--secondary);
        }
        
        .info-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            padding: 8px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .info-item:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }
        
        .label {
            font-weight: bold;
        }
        
        .value {
            color: var(--secondary);
        }
        
        .message {
            margin-top: 10px;
            padding: 10px;
            border-radius: 5px;
            text-align: center;
            display: none;
        }
        
        .message.success {
            background: rgba(46, 213, 115, 0.2);
            color: var(--success);
            border: 1px solid rgba(46, 213, 115, 0.3);
        }
        
        .message.error {
            background: rgba(255, 71, 87, 0.2);
            color: var(--error);
            border: 1px solid rgba(255, 71, 87, 0.3);
        }
        
        .tabs {
            display: flex;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            margin-bottom: 20px;
        }
        
        .tab {
            padding: 12px 20px;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
        }
        
        .tab.active {
            border-bottom: 3px solid var(--primary);
            color: var(--primary);
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .stat-card {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
            padding: 15px;
            text-align: center;
        }
        
        .stat-value {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .stat-label {
            font-size: 14px;
            color: var(--gray);
        }
        
        /* 模态框样式 */
        .modal {
            display: flex;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            align-items: center;
            justify-content: center;
        }
        
        .modal-content {
            background: linear-gradient(135deg, #1e3c72, #2a5298);
            border-radius: 15px;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            overflow: hidden;
        }
        
        .modal-header {
            padding: 20px;
            background: rgba(0, 0, 0, 0.3);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            text-align: center;
        }
        
        .modal-header h2 {
            color: var(--secondary);
            margin: 0;
        }
        
        .modal-body {
            padding: 20px;
        }
        
        @media (max-width: 768px) {
            .dashboard {
                grid-template-columns: 1fr;
            }
            
            .button-group {
                flex-direction: column;
            }
            
            .input-row {
                flex-direction: column;
                gap: 0;
            }
            
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
    <!-- 引入Supabase客户端 -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
    <!-- 管理员登录 -->
    <div id="adminLoginModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>管理员登录</h2>
            </div>
            <div class="modal-body">
                <div class="input-group">
                    <label for="adminPassword">管理员密码</label>
                    <input type="password" id="adminPassword" placeholder="请输入管理员密码">
                </div>
                <div class="button-group">
                    <button id="adminLoginBtn" class="primary-btn">登录</button>
                </div>
                <div id="adminLoginMessage" class="message"></div>
            </div>
        </div>
    </div>

    <!-- 管理后台主界面 -->
    <div class="container" id="adminContainer">
        <div class="header">
            <h1>快手转发工具 - 管理后台</h1>
            <p>卡密与系统管理</p>
            <button id="logoutBtn" class="secondary-btn">退出登录</button>
        </div>
        
        <div class="tabs">
            <div class="tab active" data-tab="dashboard">数据看板</div>
            <div class="tab" data-tab="keys">卡密管理</div>
            <div class="tab" data-tab="system">系统设置</div>
        </div>
        
        <div class="content">
            <!-- 数据看板 -->
            <div class="tab-content active" id="dashboard-tab">
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value" id="totalKeys">0</div>
                        <div class="stat-label">总卡密数</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="activeKeys">0</div>
                        <div class="stat-label">可用卡密</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="usedKeys">0</div>
                        <div class="stat-label">已使用卡密</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="expiredKeys">0</div>
                        <div class="stat-label">已过期卡密</div>
                    </div>
                </div>
                
                <div class="panel">
                    <h2>近期使用记录</h2>
                    <div class="keys-container" id="recentUsageContainer">
                        <!-- 近期使用记录将在这里显示 -->
                    </div>
                </div>
            </div>
            
            <!-- 卡密管理 -->
            <div class="tab-content" id="keys-tab">
                <div class="dashboard">
                    <div class="panel">
                        <h2>卡密创建</h2>
                        <div class="input-group">
                            <label for="keyValue">卡密内容</label>
                            <input type="text" id="keyValue" placeholder="输入卡密内容">
                        </div>
                        
                        <div class="input-row">
                            <div class="input-group">
                                <label for="keyDays">有效天数</label>
                                <input type="number" id="keyDays" value="30" min="1" max="365">
                            </div>
                            <div class="input-group">
                                <label for="keyUsageCount">使用次数</label>
                                <input type="number" id="keyUsageCount" value="1000" min="1" max="10000">
                            </div>
                        </div>
                        
                        <div class="button-group">
                            <button id="generateKeyBtn" class="primary-btn">生成卡密</button>
                            <button id="generateRandomKeysBtn" class="secondary-btn">批量生成随机卡密</button>
                        </div>
                        
                        <div class="input-group">
                            <label for="randomKeyCount">生成数量</label>
                            <input type="number" id="randomKeyCount" value="10" min="1" max="100">
                        </div>
                        
                        <div class="input-group">
                            <label for="randomKeyLength">卡密长度</label>
                            <input type="number" id="randomKeyLength" value="8" min="4" max="20">
                        </div>
                    </div>
                    
                    <div class="panel">
                        <h2>卡密操作</h2>
                        <div class="input-group">
                            <label for="searchKey">查询卡密</label>
                            <input type="text" id="searchKey" placeholder="输入卡密进行查询">
                        </div>
                        
                        <div class="button-group">
                            <button id="searchKeyBtn" class="primary-btn">查询</button>
                            <button id="exportKeysBtn" class="secondary-btn">导出卡密</button>
                        </div>
                        
                        <div class="input-group">
                            <label for="filterStatus">筛选状态</label>
                            <select id="filterStatus">
                                <option value="all">全部</option>
                                <option value="active">可用</option>
                                <option value="used">已使用</option>
                                <option value="expired">已过期</option>
                            </select>
                        </div>
                        
                        <div class="button-group">
                            <button id="deleteExpiredBtn" class="secondary-btn">删除已过期卡密</button>
                            <button id="clearUsedBtn" class="secondary-btn">清理已使用卡密</button>
                        </div>
                    </div>
                </div>
                
                <div class="keys-list">
                    <h3>卡密列表</h3>
                    <div class="keys-container" id="keysContainer">
                        <!-- 卡密列表将在这里显示 -->
                    </div>
                </div>
            </div>
            
            <!-- 系统设置 -->
            <div class="tab-content" id="system-tab">
                <div class="dashboard">
                    <div class="panel">
                        <h2>系统公告</h2>
                        
                        <div class="input-group">
                            <label for="announcementContent">公告内容</label>
                            <textarea id="announcementContent" placeholder="输入系统公告内容...">11月21日已更新，系统更加流畅生动，优化了分享速度和稳定性！</textarea>
                        </div>
                        
                        <div class="button-group">
                            <button id="saveAnnouncementBtn" class="primary-btn">保存公告</button>
                        </div>
                    </div>
                    
                    <div class="panel">
                        <h2>系统信息</h2>
                        
                        <div class="system-info">
                            <div class="info-item">
                                <span class="label">系统版本:</span>
                                <span class="value">2.0</span>
                            </div>
                            <div class="info-item">
                                <span class="label">数据库连接:</span>
                                <span class="value" id="dbStatus">未知</span>
                            </div>
                            <div class="info-item">
                                <span class="label">最后更新:</span>
                                <span class="value" id="lastUpdate">-</span>
                            </div>
                        </div>
                        
                        <div class="button-group">
                            <button id="refreshStatsBtn" class="secondary-btn">刷新统计</button>
                            <button id="backupDataBtn" class="secondary-btn">备份数据</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="supabase-config.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // 元素引用
            const adminLoginModal = document.getElementById('adminLoginModal');
            const adminContainer = document.getElementById('adminContainer');
            const adminPassword = document.getElementById('adminPassword');
            const adminLoginBtn = document.getElementById('adminLoginBtn');
            const adminLoginMessage = document.getElementById('adminLoginMessage');
            const logoutBtn = document.getElementById('logoutBtn');
            
            const tabs = document.querySelectorAll('.tab');
            const tabContents = document.querySelectorAll('.tab-content');
            
            // 数据看板元素
            const totalKeysSpan = document.getElementById('totalKeys');
            const activeKeysSpan = document.getElementById('activeKeys');
            const usedKeysSpan = document.getElementById('usedKeys');
            const expiredKeysSpan = document.getElementById('expiredKeys');
            const recentUsageContainer = document.getElementById('recentUsageContainer');
            const dbStatusSpan = document.getElementById('dbStatus');
            const lastUpdateSpan = document.getElementById('lastUpdate');
            
            // 卡密管理元素
            const keyValueInput = document.getElementById('keyValue');
            const keyDaysInput = document.getElementById('keyDays');
            const keyUsageCountInput = document.getElementById('keyUsageCount');
            const generateKeyBtn = document.getElementById('generateKeyBtn');
            const generateRandomKeysBtn = document.getElementById('generateRandomKeysBtn');
            const randomKeyCountInput = document.getElementById('randomKeyCount');
            const randomKeyLengthInput = document.getElementById('randomKeyLength');
            const searchKeyInput = document.getElementById('searchKey');
            const searchKeyBtn = document.getElementById('searchKeyBtn');
            const exportKeysBtn = document.getElementById('exportKeysBtn');
            const filterStatusSelect = document.getElementById('filterStatus');
            const deleteExpiredBtn = document.getElementById('deleteExpiredBtn');
            const clearUsedBtn = document.getElementById('clearUsedBtn');
            const keysContainer = document.getElementById('keysContainer');
            
            // 系统设置元素
            const announcementContent = document.getElementById('announcementContent');
            const saveAnnouncementBtn = document.getElementById('saveAnnouncementBtn');
            const refreshStatsBtn = document.getElementById('refreshStatsBtn');
            const backupDataBtn = document.getElementById('backupDataBtn');
            
            // 管理员密码
            const ADMIN_PASSWORD = '5418854188';
            
            // 初始化
            function init() {
                // 显示管理员登录弹窗
                adminLoginModal.style.display = 'flex';
                adminContainer.style.display = 'none';
                
                // 设置标签切换
                setupTabs();
                
                // 测试数据库连接
                testDatabaseConnection();
            }
            
            // 设置标签切换
            function setupTabs() {
                tabs.forEach(tab => {
                    tab.addEventListener('click', () => {
                        const tabId = tab.getAttribute('data-tab');
                        
                        // 移除所有active类
                        tabs.forEach(t => t.classList.remove('active'));
                        tabContents.forEach(tc => tc.classList.remove('active'));
                        
                        // 添加active类到当前标签
                        tab.classList.add('active');
                        document.getElementById(`${tabId}-tab`).classList.add('active');
                        
                        // 如果切换到数据看板，刷新统计数据
                        if (tabId === 'dashboard') {
                            loadDashboardStats();
                        }
                        
                        // 如果切换到卡密管理，加载卡密列表
                        if (tabId === 'keys') {
                            loadKeys();
                        }
                    });
                });
            }
            
            // 测试数据库连接
            async function testDatabaseConnection() {
                try {
                    const { data, error } = await supabase
                        .from(TABLES.CARDS)
                        .select('count')
                        .limit(1);
                    
                    if (error) throw error;
                    
                    dbStatusSpan.textContent = '正常';
                    dbStatusSpan.style.color = 'var(--success)';
                } catch (error) {
                    console.error('数据库连接失败:', error);
                    dbStatusSpan.textContent = '失败';
                    dbStatusSpan.style.color = 'var(--error)';
                }
            }
            
            // 管理员登录
            adminLoginBtn.addEventListener('click', function() {
                const password = adminPassword.value.trim();
                
                if (!password) {
                    showMessage('请输入管理员密码', 'error');
                    return;
                }
                
                if (password === ADMIN_PASSWORD) {
                    // 登录成功
                    adminLoginModal.style.display = 'none';
                    adminContainer.style.display = 'block';
                    
                    // 加载初始数据
                    loadDashboardStats();
                    loadAnnouncement();
                } else {
                    showMessage('密码错误', 'error');
                }
            });
            
            // 退出登录
            logoutBtn.addEventListener('click', function() {
                adminContainer.style.display = 'none';
                adminLoginModal.style.display = 'flex';
                adminPassword.value = '';
            });
            
            // 生成卡密
            generateKeyBtn.addEventListener('click', async function() {
                const keyValue = keyValueInput.value.trim();
                const keyDays = parseInt(keyDaysInput.value);
                const usageCount = parseInt(keyUsageCountInput.value);
                
                if (!keyValue) {
                    showMessage('请输入卡密内容', 'error');
                    return;
                }
                
                if (isNaN(keyDays) || keyDays <= 0) {
                    showMessage('有效天数必须是大于0的整数', 'error');
                    return;
                }
                
                if (isNaN(usageCount) || usageCount <= 0) {
                    showMessage('使用次数必须是大于0的整数', 'error');
                    return;
                }
                
                // 检查卡密是否已存在
                try {
                    const { data: existingKey, error } = await supabase
                        .from(TABLES.CARDS)
                        .select('*')
                        .eq('key', keyValue)
                        .single();
                    
                    if (existingKey) {
                        showMessage('卡密已存在，请使用其他内容', 'error');
                        return;
                    }
                } catch (error) {
                    // 卡密不存在，继续创建
                }
                
                // 计算到期日期
                const expiryDate = new Date();
                expiryDate.setDate(expiryDate.getDate() + keyDays);
                
                // 创建卡密对象
                const key = {
                    key: keyValue,
                    expires_at: expiryDate.toISOString(),
                    remaining_uses: usageCount,
                    total_uses: usageCount,
                    status: KEY_STATUS.ACTIVE,
                    created_at: new Date().toISOString(),
                    updated_at: new Date().toISOString()
                };
                
                try {
                    const { data, error } = await supabase
                        .from(TABLES.CARDS)
                        .insert([key]);
                    
                    if (error) throw error;
                    
                    // 清空输入框
                    keyValueInput.value = '';
                    
                    // 重新加载卡密列表
                    loadKeys();
                    loadDashboardStats();
                    
                    showMessage('卡密生成成功', 'success');
                } catch (error) {
                    console.error('生成卡密失败:', error);
                    showMessage('生成卡密失败: ' + error.message, 'error');
                }
            });
            
            // 批量生成随机卡密
            generateRandomKeysBtn.addEventListener('click', async function() {
                const count = parseInt(randomKeyCountInput.value);
                const length = parseInt(randomKeyLengthInput.value);
                
                if (isNaN(count) || count <= 0) {
                    showMessage('生成数量必须是大于0的整数', 'error');
                    return;
                }
                
                if (isNaN(length) || length < 4) {
                    showMessage('卡密长度必须至少为4位', 'error');
                    return;
                }
                
                const keyDays = parseInt(keyDaysInput.value);
                const usageCount = parseInt(keyUsageCountInput.value);
                
                // 计算到期日期
                const expiryDate = new Date();
                expiryDate.setDate(expiryDate.getDate() + keyDays);
                
                // 生成随机卡密
                const keys = [];
                for (let i = 0; i < count; i++) {
                    const randomKey = generateRandomKey(length);
                    keys.push({
                        key: randomKey,
                        expires_at: expiryDate.toISOString(),
                        remaining_uses: usageCount,
                        total_uses: usageCount,
                        status: KEY_STATUS.ACTIVE,
                        created_at: new Date().toISOString(),
                        updated_at: new Date().toISOString()
                    });
                }
                
                try {
                    const { data, error } = await supabase
                        .from(TABLES.CARDS)
                        .insert(keys);
                    
                    if (error) throw error;
                    
                    // 重新加载卡密列表
                    loadKeys();
                    loadDashboardStats();
                    
                    showMessage(`成功生成 ${count} 个随机卡密`, 'success');
                } catch (error) {
                    console.error('批量生成卡密失败:', error);
                    showMessage('批量生成卡密失败: ' + error.message, 'error');
                }
            });
            
            // 查询卡密
            searchKeyBtn.addEventListener('click', function() {
                const searchKey = searchKeyInput.value.trim();
                if (searchKey) {
                    loadKeys(searchKey);
                } else {
                    loadKeys();
                }
            });
            
            // 导出卡密
            exportKeysBtn.addEventListener('click', function() {
                exportKeysToCSV();
            });
            
            // 筛选状态变化
            filterStatusSelect.addEventListener('change', function() {
                loadKeys();
            });
            
            // 删除已过期卡密
            deleteExpiredBtn.addEventListener('click', async function() {
                if (!confirm('确定要删除所有已过期卡密吗？此操作不可恢复！')) {
                    return;
                }
                
                try {
                    const { error } = await supabase
                        .from(TABLES.CARDS)
                        .delete()
                        .eq('status', KEY_STATUS.EXPIRED);
                    
                    if (error) throw error;
                    
                    loadKeys();
                    loadDashboardStats();
                    
                    showMessage('已删除所有过期卡密', 'success');
                } catch (error) {
                    console.error('删除过期卡密失败:', error);
                    showMessage('删除过期卡密失败: ' + error.message, 'error');
                }
            });
            
            // 清理已使用卡密
            clearUsedBtn.addEventListener('click', async function() {
                if (!confirm('确定要清理所有已使用卡密吗？此操作不可恢复！')) {
                    return;
                }
                
                try {
                    const { error } = await supabase
                        .from(TABLES.CARDS)
                        .delete()
                        .eq('status', KEY_STATUS.USED);
                    
                    if (error) throw error;
                    
                    loadKeys();
                    loadDashboardStats();
                    
                    showMessage('已清理所有已使用卡密', 'success');
                } catch (error) {
                    console.error('清理已使用卡密失败:', error);
                    showMessage('清理已使用卡密失败: ' + error.message, 'error');
                }
            });
            
            // 保存公告
            saveAnnouncementBtn.addEventListener('click', async function() {
                const content = announcementContent.value.trim();
                
                if (!content) {
                    showMessage('请输入公告内容', 'error');
                    return;
                }
                
                try {
                    const { error } = await supabase
                        .from(TABLES.ANNOUNCEMENTS)
                        .insert([{
                            content: content,
                            created_at: new Date().toISOString()
                        }]);
                    
                    if (error) throw error;
                    
                    showMessage('公告保存成功', 'success');
                } catch (error) {
                    console.error('保存公告失败:', error);
                    showMessage('保存公告失败: ' + error.message, 'error');
                }
            });
            
            // 刷新统计
            refreshStatsBtn.addEventListener('click', function() {
                loadDashboardStats();
                testDatabaseConnection();
            });
            
            // 备份数据
            backupDataBtn.addEventListener('click', function() {
                exportKeysToCSV();
            });
            
            // 加载数据看板统计
            async function loadDashboardStats() {
                try {
                    // 获取总卡密数
                    const { count: totalCount, error: totalError } = await supabase
                        .from(TABLES.CARDS)
                        .select('*', { count: 'exact', head: true });
                    
                    if (totalError) throw totalError;
                    
                    // 获取可用卡密数
                    const { count: activeCount, error: activeError } = await supabase
                        .from(TABLES.CARDS)
                        .select('*', { count: 'exact', head: true })
                        .eq('status', KEY_STATUS.ACTIVE)
                        .gte('expires_at', new Date().toISOString())
                        .gt('remaining_uses', 0);
                    
                    if (activeError) throw activeError;
                    
                    // 获取已使用卡密数
                    const { count: usedCount, error: usedError } = await supabase
                        .from(TABLES.CARDS)
                        .select('*', { count: 'exact', head: true })
                        .eq('status', KEY_STATUS.USED);
                    
                    if (usedError) throw usedError;
                    
                    // 获取已过期卡密数
                    const { count: expiredCount, error: expiredError } = await supabase
                        .from(TABLES.CARDS)
                        .select('*', { count: 'exact', head: true })
                        .eq('status', KEY_STATUS.EXPIRED);
                    
                    if (expiredError) throw expiredError;
                    
                    // 更新显示
                    totalKeysSpan.textContent = totalCount || 0;
                    activeKeysSpan.textContent = activeCount || 0;
                    usedKeysSpan.textContent = usedCount || 0;
                    expiredKeysSpan.textContent = expiredCount || 0;
                    
                    // 更新最后更新时间
                    lastUpdateSpan.textContent = new Date().toLocaleString();
                    
                    // 加载近期使用记录
                    loadRecentUsage();
                } catch (error) {
                    console.error('加载统计数据失败:', error);
                }
            }
            
            // 加载近期使用记录
            async function loadRecentUsage() {
                try {
                    const { data, error } = await supabase
                        .from(TABLES.USAGE_LOGS)
                        .select(`
                            *,
                            cards:card_id (
                                key
                            )
                        `)
                        .order('used_at', { ascending: false })
                        .limit(10);
                    
                    if (error) throw error;
                    
                    recentUsageContainer.innerHTML = '';
                    
                    if (data && data.length > 0) {
                        data.forEach(log => {
                            const logItem = document.createElement('div');
                            logItem.className = 'key-item';
                            
                            const logInfo = document.createElement('div');
                            logInfo.className = 'key-info';
                            
                            const logValue = document.createElement('div');
                            logValue.className = 'key-value';
                            logValue.textContent = log.cards.key;
                            
                            const logDetails = document.createElement('div');
                            logDetails.className = 'key-details';
                            logDetails.textContent = `使用时间: ${new Date(log.used_at).toLocaleString()}`;
                            
                            logInfo.appendChild(logValue);
                            logInfo.appendChild(logDetails);
                            logItem.appendChild(logInfo);
                            
                            recentUsageContainer.appendChild(logItem);
                        });
                    } else {
                        recentUsageContainer.innerHTML = '<div style="text-align: center; padding: 20px; color: var(--gray);">暂无使用记录</div>';
                    }
                } catch (error) {
                    console.error('加载使用记录失败:', error);
                    recentUsageContainer.innerHTML = '<div style="text-align: center; padding: 20px; color: var(--error);">加载失败</div>';
                }
            }
            
            // 加载卡密列表
            async function loadKeys(searchKey = '') {
                try {
                    let query = supabase
                        .from(TABLES.CARDS)
                        .select('*')
                        .order('created_at', { ascending: false });
                    
                    // 应用搜索条件
                    if (searchKey) {
                        query = query.ilike('key', `%${searchKey}%`);
                    }
                    
                    // 应用状态筛选
                    const filterStatus = filterStatusSelect.value;
                    if (filterStatus !== 'all') {
                        query = query.eq('status', filterStatus);
                    }
                    
                    const { data, error } = await query;
                    
                    if (error) throw error;
                    
                    keysContainer.innerHTML = '';
                    
                    if (data && data.length > 0) {
                        data.forEach(key => {
                            const keyItem = document.createElement('div');
                            keyItem.className = 'key-item';
                            
                            const keyInfo = document.createElement('div');
                            keyInfo.className = 'key-info';
                            
                            const keyValue = document.createElement('div');
                            keyValue.className = 'key-value';
                            keyValue.textContent = key.key;
                            
                            const keyDetails = document.createElement('div');
                            keyDetails.className = 'key-details';
                            keyDetails.innerHTML = `
                                有效期: ${new Date(key.expires_at).toLocaleDateString()} | 
                                剩余次数: ${key.remaining_uses}/${key.total_uses} | 
                                状态: ${getStatusText(key.status)}
                            `;
                            
                            keyInfo.appendChild(keyValue);
                            keyInfo.appendChild(keyDetails);
                            
                            const keyActions = document.createElement('div');
                            keyActions.className = 'key-actions';
                            
                            const deleteBtn = document.createElement('button');
                            deleteBtn.className = 'delete-btn';
                            deleteBtn.textContent = '删除';
                            deleteBtn.addEventListener('click', function() {
                                deleteKey(key.id);
                            });
                            
                            keyActions.appendChild(deleteBtn);
                            
                            keyItem.appendChild(keyInfo);
                            keyItem.appendChild(keyActions);
                            
                            keysContainer.appendChild(keyItem);
                        });
                    } else {
                        keysContainer.innerHTML = '<div style="text-align: center; padding: 20px; color: var(--gray);">暂无卡密</div>';
                    }
                } catch (error) {
                    console.error('加载卡密列表失败:', error);
                    keysContainer.innerHTML = '<div style="text-align: center; padding: 20px; color: var(--error);">加载失败</div>';
                }
            }
            
            // 加载公告
            async function loadAnnouncement() {
                try {
                    const { data, error } = await supabase
                        .from(TABLES.ANNOUNCEMENTS)
                        .select('*')
                        .order('created_at', { ascending: false })
                        .limit(1);
                    
                    if (error) throw error;
                    
                    if (data && data.length > 0) {
                        announcementContent.value = data[0].content;
                    }
                } catch (error) {
                    console.error('加载公告失败:', error);
                }
            }
            
            // 删除卡密
            async function deleteKey(keyId) {
                if (!confirm('确定要删除这个卡密吗？此操作不可恢复！')) {
                    return;
                }
                
                try {
                    const { error } = await supabase
                        .from(TABLES.CARDS)
                        .delete()
                        .eq('id', keyId);
                    
                    if (error) throw error;
                    
                    loadKeys();
                    loadDashboardStats();
                    
                    showMessage('卡密删除成功', 'success');
                } catch (error) {
                    console.error('删除卡密失败:', error);
                    showMessage('删除卡密失败: ' + error.message, 'error');
                }
            }
            
            // 导出卡密到CSV
            async function exportKeysToCSV() {
                try {
                    const { data, error } = await supabase
                        .from(TABLES.CARDS)
                        .select('*');
                    
                    if (error) throw error;
                    
                    if (!data || data.length === 0) {
                        showMessage('没有卡密数据可导出', 'error');
                        return;
                    }
                    
                    // 创建CSV内容
                    let csvContent = '卡密,有效期,总次数,剩余次数,状态,创建时间\n';
                    
                    data.forEach(key => {
                        csvContent += `"${key.key}","${new Date(key.expires_at).toLocaleDateString()}","${key.total_uses}","${key.remaining_uses}","${getStatusText(key.status)}","${new Date(key.created_at).toLocaleString()}"\n`;
                    });
                    
                    // 创建下载链接
                    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                    const url = URL.createObjectURL(blob);
                    const link = document.createElement('a');
                    link.setAttribute('href', url);
                    link.setAttribute('download', `卡密备份_${new Date().toISOString().split('T')[0]}.csv`);
                    link.style.visibility = 'hidden';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    
                    showMessage('卡密数据导出成功', 'success');
                } catch (error) {
                    console.error('导出卡密失败:', error);
                    showMessage('导出卡密失败: ' + error.message, 'error');
                }
            }
            
            // 生成随机卡密
            function generateRandomKey(length) {
                const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
                let result = '';
                for (let i = 0; i < length; i++) {
                    result += chars.charAt(Math.floor(Math.random() * chars.length));
                }
                return result;
            }
            
            // 获取状态文本
            function getStatusText(status) {
                switch (status) {
                    case KEY_STATUS.ACTIVE: return '可用';
                    case KEY_STATUS.USED: return '已使用';
                    case KEY_STATUS.EXPIRED: return '已过期';
                    default: return '未知';
                }
            }
            
            // 显示消息
            function showMessage(message, type) {
                adminLoginMessage.textContent = message;
                adminLoginMessage.className = `message ${type}`;
                adminLoginMessage.style.display = 'block';
                
                setTimeout(() => {
                    adminLoginMessage.style.display = 'none';
                }, 3000);
            }
            
            // 初始化应用
            init();
        });
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>管理后台 - 快手转发工具</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #ff6b6b;
            --secondary: #4ecdc4;
            --accent: #ff9f43;
            --dark: #2f3542;
            --light: #f1f2f6;
            --gray: #a4b0be;
            --success: #2ed573;
            --warning: #ffa502;
            --error: #ff4757;
            --card-bg: rgba(255, 255, 255, 0.1);
            --card-border: rgba(255, 255, 255, 0.2);
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Arial, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #1e3c72, #2a5298);
            color: white;
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            width: 100%;
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(10px);
            display: none;
            border: 1px solid var(--card-border);
            animation: fadeIn 0.8s ease-out;
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid var(--card-border);
        }
        
        .header h1 {
            font-size: 32px;
            margin-bottom: 10px;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            font-weight: 700;
        }
        
        .header p {
            color: var(--gray);
            font-size: 16px;
        }
        
        .dashboard {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .panel {
            background: var(--card-bg);
            border-radius: 15px;
            padding: 20px;
            border: 1px solid var(--card-border);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
            transition: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }
        
        .panel:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 30px rgba(0, 0, 0, 0.3);
        }
        
        .panel h2 {
            margin-bottom: 15px;
            color: var(--secondary);
            border-bottom: 1px solid var(--card-border);
            padding-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .input-group {
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
        }
        
        input, textarea, select {
            width: 100%;
            padding: 12px;
            border-radius: 8px;
            border: 1px solid var(--card-border);
            background: rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 16px;
            transition: all 0.3s;
        }
        
        textarea {
            min-height: 100px;
            resize: vertical;
        }
        
        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 2px rgba(255, 107, 107, 0.2);
        }
        
        input::placeholder, textarea::placeholder {
            color: rgba(255, 255, 255, 0.6);
        }
        
        .input-row {
            display: flex;
            gap: 15px;
        }
        
        .input-row .input-group {
            flex: 1;
        }
        
        .button-group {
            display: flex;
            gap: 15px;
            margin-top: 20px;
        }
        
        button {
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            font-size: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .primary-btn {
            background: linear-gradient(135deg, var(--primary), #ff5252);
            color: white;
        }
        
        .primary-btn:hover:not(:disabled) {
            background: #ff5252;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 107, 107, 0.4);
        }
        
        .primary-btn:disabled {
            background: var(--gray);
            cursor: not-allowed;
        }
        
        .secondary-btn {
            background: rgba(255, 255, 255, 0.1);
            color: var(--light);
            border: 1px solid var(--card-border);
        }
        
        .secondary-btn:hover:not(:disabled) {
            background: rgba(255, 255, 255, 0.15);
        }
        
        .accent-btn {
            background: linear-gradient(135deg, var(--accent), #ff7e00);
            color: white;
        }
        
        .accent-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 159, 67, 0.4);
        }
        
        .keys-list {
            margin-top: 20px;
        }
        
        .keys-list h3 {
            margin-bottom: 10px;
            color: var(--secondary);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .keys-container {
            max-height: 300px;
            overflow-y: auto;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
            padding: 15px;
            border: 1px solid var(--card-border);
        }
        
        .key-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            border-bottom: 1px solid var(--card-border);
            transition: background 0.3s;
        }
        
        .key-item:hover {
            background: rgba(255, 255, 255, 0.05);
        }
        
        .key-item:last-child {
            border-bottom: none;
        }
        
        .key-info {
            flex: 1;
        }
        
        .key-value {
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .key-details {
            font-size: 12px;
            color: var(--gray);
        }
        
        .key-actions {
            display: flex;
            gap: 10px;
        }
        
        .delete-btn {
            background: var(--error);
            color: white;
            padding: 5px 10px;
            font-size: 12px;
            border-radius: 5px;
        }
        
        .system-info {
            margin-top: 20px;
        }
        
        .system-info h3 {
            margin-bottom: 10px;
            color: var(--secondary);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .info-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            padding: 8px 0;
            border-bottom: 1px solid var(--card-border);
        }
        
        .info-item:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }
        
        .label {
            font-weight: bold;
        }
        
        .value {
            color: var(--secondary);
        }
        
        .message {
            margin-top: 10px;
            padding: 10px;
            border-radius: 5px;
            text-align: center;
            display: none;
        }
        
        .message.success {
            background: rgba(46, 213, 115, 0.2);
            color: var(--success);
            border: 1px solid rgba(46, 213, 115, 0.3);
        }
        
        .message.error {
            background: rgba(255, 71, 87, 0.2);
            color: var(--error);
            border: 1px solid rgba(255, 71, 87, 0.3);
        }
        
        .tabs {
            display: flex;
            border-bottom: 1px solid var(--card-border);
            margin-bottom: 20px;
        }
        
        .tab {
            padding: 12px 20px;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .tab.active {
            border-bottom: 3px solid var(--primary);
            color: var(--primary);
        }
        
        .tab-content {
            display: none;
            animation: fadeIn 0.5s ease-in-out;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .stat-card {
            background: var(--card-bg);
            border-radius: 15px;
            padding: 15px;
            text-align: center;
            border: 1px solid var(--card-border);
            transition: all 0.3s;
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
        }
        
        .stat-value {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .stat-label {
            font-size: 14px;
            color: var(--gray);
        }
        
        /* 模态框样式 */
        .modal {
            display: flex;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            align-items: center;
            justify-content: center;
        }
        
        .modal-content {
            background: linear-gradient(135deg, #1e3c72, #2a5298);
            border-radius: 20px;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.5);
            overflow: hidden;
            border: 1px solid var(--card-border);
            animation: modalAppear 0.5s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }
        
        .modal-header {
            padding: 20px;
            background: rgba(0, 0, 0, 0.3);
            border-bottom: 1px solid var(--card-border);
            text-align: center;
        }
        
        .modal-header h2 {
            color: var(--secondary);
            margin: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .modal-body {
            padding: 20px;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        @keyframes modalAppear {
            from {
                opacity: 0;
                transform: scale(0.9) translateY(-20px);
            }
            to {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }
        
        @media (max-width: 768px) {
            .dashboard {
                grid-template-columns: 1fr;
            }
            
            .button-group {
                flex-direction: column;
            }
            
            .input-row {
                flex-direction: column;
                gap: 0;
            }
            
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
</head>
<body>
    <!-- 管理员登录 -->
    <div id="adminLoginModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2><i class="fas fa-lock"></i> 管理员登录</h2>
            </div>
            <div class="modal-body">
                <div class="input-group">
                    <label for="adminPassword">管理员密码</label>
                    <input type="password" id="adminPassword" placeholder="请输入管理员密码">
                </div>
                <div class="button-group">
                    <button id="adminLoginBtn" class="primary-btn"><i class="fas fa-sign-in-alt"></i> 登录</button>
                </div>
                <div id="adminLoginMessage" class="message"></div>
            </div>
        </div>
    </div>

    <!-- 管理后台主界面 -->
    <div class="container" id="adminContainer">
        <div class="header">
            <h1>快手转发工具 - 管理后台</h1>
            <p>卡密与系统管理</p>
            <button id="logoutBtn" class="secondary-btn"><i class="fas fa-sign-out-alt"></i> 退出登录</button>
        </div>
        
        <div class="tabs">
            <div class="tab active" data-tab="dashboard"><i class="fas fa-tachometer-alt"></i> 数据看板</div>
            <div class="tab" data-tab="keys"><i class="fas fa-key"></i> 卡密管理</div>
            <div class="tab" data-tab="system"><i class="fas fa-cog"></i> 系统设置</div>
        </div>
        
        <div class="content">
            <!-- 数据看板 -->
            <div class="tab-content active" id="dashboard-tab">
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value" id="totalKeys">0</div>
                        <div class="stat-label">总卡密数</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="activeKeys">0</div>
                        <div class="stat-label">可用卡密</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="usedKeys">0</div>
                        <div class="stat-label">已使用卡密</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="expiredKeys">0</div>
                        <div class="stat-label">已过期卡密</div>
                    </div>
                </div>
                
                <div class="panel">
                    <h2><i class="fas fa-history"></i> 近期使用记录</h2>
                    <div class="keys-container" id="recentUsageContainer">
                        <!-- 近期使用记录将在这里显示 -->
                        <div style="text-align: center; padding: 20px; color: var(--gray);">暂无使用记录</div>
                    </div>
                </div>
            </div>
            
            <!-- 卡密管理 -->
            <div class="tab-content" id="keys-tab">
                <div class="dashboard">
                    <div class="panel">
                        <h2><i class="fas fa-plus-circle"></i> 卡密创建</h2>
                        <div class="input-group">
                            <label for="keyValue">卡密内容</label>
                            <input type="text" id="keyValue" placeholder="输入卡密内容">
                        </div>
                        
                        <div class="input-row">
                            <div class="input-group">
                                <label for="keyDays">有效天数</label>
                                <input type="number" id="keyDays" value="0" min="0" max="365">
                            </div>
                            <div class="input-group">
                                <label for="keyHours">有效小时</label>
                                <input type="number" id="keyHours" value="1" min="0" max="23">
                            </div>
                            <div class="input-group">
                                <label for="keyMinutes">有效分钟</label>
                                <input type="number" id="keyMinutes" value="0" min="0" max="59">
                            </div>
                        </div>
                        
                        <div class="input-group">
                            <label for="keyUsageCount">使用次数</label>
                            <input type="number" id="keyUsageCount" value="1000" min="1" max="10000">
                        </div>
                        
                        <div class="button-group">
                            <button id="generateKeyBtn" class="primary-btn"><i class="fas fa-key"></i> 生成卡密</button>
                            <button id="generateRandomKeysBtn" class="accent-btn"><i class="fas fa-random"></i> 批量生成随机卡密</button>
                        </div>
                        
                        <div class="input-group">
                            <label for="randomKeyCount">生成数量</label>
                            <input type="number" id="randomKeyCount" value="10" min="1" max="100">
                        </div>
                        
                        <div class="input-group">
                            <label for="randomKeyLength">卡密长度</label>
                            <input type="number" id="randomKeyLength" value="8" min="4" max="20">
                        </div>
                    </div>
                    
                    <div class="panel">
                        <h2><i class="fas fa-tasks"></i> 卡密操作</h2>
                        <div class="input-group">
                            <label for="searchKey">查询卡密</label>
                            <input type="text" id="searchKey" placeholder="输入卡密进行查询">
                        </div>
                        
                        <div class="button-group">
                            <button id="searchKeyBtn" class="primary-btn"><i class="fas fa-search"></i> 查询</button>
                            <button id="exportKeysBtn" class="secondary-btn"><i class="fas fa-download"></i> 导出卡密</button>
                        </div>
                        
                        <div class="input-group">
                            <label for="filterStatus">筛选状态</label>
                            <select id="filterStatus">
                                <option value="all">全部</option>
                                <option value="active">可用</option>
                                <option value="used">已使用</option>
                                <option value="expired">已过期</option>
                                <option value="unused">未使用</option>
                            </select>
                        </div>
                        
                        <div class="button-group">
                            <button id="deleteExpiredBtn" class="secondary-btn"><i class="fas fa-trash"></i> 删除已过期卡密</button>
                            <button id="clearUsedBtn" class="secondary-btn"><i class="fas fa-broom"></i> 清理已使用卡密</button>
                        </div>
                    </div>
                </div>
                
                <div class="keys-list">
                    <h3><i class="fas fa-list"></i> 卡密列表</h3>
                    <div class="keys-container" id="keysContainer">
                        <!-- 卡密列表将在这里显示 -->
                        <div style="text-align: center; padding: 20px; color: var(--gray);">暂无卡密</div>
                    </div>
                </div>
            </div>
            
            <!-- 系统设置 -->
            <div class="tab-content" id="system-tab">
                <div class="dashboard">
                    <div class="panel">
                        <h2><i class="fas fa-bullhorn"></i> 系统公告</h2>
                        
                        <div class="input-group">
                            <label for="announcementContent">公告内容</label>
                            <textarea id="announcementContent" placeholder="输入系统公告内容...">11月21日已更新，系统更加流畅生动，优化了分享速度和稳定性！</textarea>
                        </div>
                        
                        <div class="button-group">
                            <button id="saveAnnouncementBtn" class="primary-btn"><i class="fas fa-save"></i> 保存公告</button>
                        </div>
                    </div>
                    
                    <div class="panel">
                        <h2><i class="fas fa-info-circle"></i> 系统信息</h2>
                        
                        <div class="system-info">
                            <div class="info-item">
                                <span class="label">系统版本:</span>
                                <span class="value">2.1</span>
                            </div>
                            <div class="info-item">
                                <span class="label">数据库连接:</span>
                                <span class="value" id="dbStatus">正常</span>
                            </div>
                            <div class="info-item">
                                <span class="label">最后更新:</span>
                                <span class="value" id="lastUpdate">-</span>
                            </div>
                        </div>
                        
                        <div class="button-group">
                            <button id="refreshStatsBtn" class="secondary-btn"><i class="fas fa-sync"></i> 刷新统计</button>
                            <button id="backupDataBtn" class="secondary-btn"><i class="fas fa-database"></i> 备份数据</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // 元素引用
            const adminLoginModal = document.getElementById('adminLoginModal');
            const adminContainer = document.getElementById('adminContainer');
            const adminPassword = document.getElementById('adminPassword');
            const adminLoginBtn = document.getElementById('adminLoginBtn');
            const adminLoginMessage = document.getElementById('adminLoginMessage');
            const logoutBtn = document.getElementById('logoutBtn');
            
            const tabs = document.querySelectorAll('.tab');
            const tabContents = document.querySelectorAll('.tab-content');
            
            // 数据看板元素
            const totalKeysSpan = document.getElementById('totalKeys');
            const activeKeysSpan = document.getElementById('activeKeys');
            const usedKeysSpan = document.getElementById('usedKeys');
            const expiredKeysSpan = document.getElementById('expiredKeys');
            const recentUsageContainer = document.getElementById('recentUsageContainer');
            const dbStatusSpan = document.getElementById('dbStatus');
            const lastUpdateSpan = document.getElementById('lastUpdate');
            
            // 卡密管理元素
            const keyValueInput = document.getElementById('keyValue');
            const keyDaysInput = document.getElementById('keyDays');
            const keyHoursInput = document.getElementById('keyHours');
            const keyMinutesInput = document.getElementById('keyMinutes');
            const keyUsageCountInput = document.getElementById('keyUsageCount');
            const generateKeyBtn = document.getElementById('generateKeyBtn');
            const generateRandomKeysBtn = document.getElementById('generateRandomKeysBtn');
            const randomKeyCountInput = document.getElementById('randomKeyCount');
            const randomKeyLengthInput = document.getElementById('randomKeyLength');
            const searchKeyInput = document.getElementById('searchKey');
            const searchKeyBtn = document.getElementById('searchKeyBtn');
            const exportKeysBtn = document.getElementById('exportKeysBtn');
            const filterStatusSelect = document.getElementById('filterStatus');
            const deleteExpiredBtn = document.getElementById('deleteExpiredBtn');
            const clearUsedBtn = document.getElementById('clearUsedBtn');
            const keysContainer = document.getElementById('keysContainer');
            
            // 系统设置元素
            const announcementContent = document.getElementById('announcementContent');
            const saveAnnouncementBtn = document.getElementById('saveAnnouncementBtn');
            const refreshStatsBtn = document.getElementById('refreshStatsBtn');
            const backupDataBtn = document.getElementById('backupDataBtn');
            
            // 管理员密码
            const ADMIN_PASSWORD = '5418854188';
            
            // 数据库
            let keysDatabase = [];
            let announcementsDatabase = [];
            let usageLogs = [];
            
            // 初始化
            function init() {
                console.log('初始化管理员后台...');
                
                // 显示管理员登录弹窗
                adminLoginModal.style.display = 'flex';
                adminContainer.style.display = 'none';
                
                // 加载数据
                loadData();
                
                // 设置标签切换
                setupTabs();
                
                // 设置事件监听器
                setupEventListeners();
                
                console.log('管理员后台初始化完成');
            }
            
            // 加载数据
            function loadData() {
                try {
                    keysDatabase = JSON.parse(localStorage.getItem('keysDatabase') || '[]');
                    announcementsDatabase = JSON.parse(localStorage.getItem('announcementsDatabase') || '[]');
                    usageLogs = JSON.parse(localStorage.getItem('usageLogs') || '[]');
                    
                    // 迁移旧数据 - 确保每个卡密都有firstUsedAt字段
                    let needsSave = false;
                    keysDatabase.forEach(key => {
                        if (!key.hasOwnProperty('firstUsedAt')) {
                            key.firstUsedAt = null;
                            needsSave = true;
                        }
                    });
                    
                    if (needsSave) {
                        saveData();
                    }
                    
                    console.log('数据加载成功:', {
                        keys: keysDatabase.length,
                        announcements: announcementsDatabase.length,
                        logs: usageLogs.length
                    });
                } catch (e) {
                    console.error('加载数据失败:', e);
                    // 初始化空数据
                    keysDatabase = [];
                    announcementsDatabase = [];
                    usageLogs = [];
                }
            }
            
            // 保存数据
            function saveData() {
                try {
                    localStorage.setItem('keysDatabase', JSON.stringify(keysDatabase));
                    localStorage.setItem('announcementsDatabase', JSON.stringify(announcementsDatabase));
                    localStorage.setItem('usageLogs', JSON.stringify(usageLogs));
                    console.log('数据保存成功');
                } catch (e) {
                    console.error('保存数据失败:', e);
                    showMessage('保存数据失败', 'error');
                }
            }
            
            // 设置标签切换
            function setupTabs() {
                tabs.forEach(tab => {
                    tab.addEventListener('click', () => {
                        const tabId = tab.getAttribute('data-tab');
                        
                        // 移除所有active类
                        tabs.forEach(t => t.classList.remove('active'));
                        tabContents.forEach(tc => tc.classList.remove('active'));
                        
                        // 添加active类到当前标签
                        tab.classList.add('active');
                        document.getElementById(`${tabId}-tab`).classList.add('active');
                        
                        // 如果切换到数据看板，刷新统计数据
                        if (tabId === 'dashboard') {
                            loadDashboardStats();
                        }
                        
                        // 如果切换到卡密管理，加载卡密列表
                        if (tabId === 'keys') {
                            loadKeys();
                        }
                    });
                });
            }
            
            // 设置事件监听器
            function setupEventListeners() {
                // 管理员登录
                adminLoginBtn.addEventListener('click', function() {
                    const password = adminPassword.value.trim();
                    
                    if (!password) {
                        showMessage('请输入管理员密码', 'error');
                        return;
                    }
                    
                    if (password === ADMIN_PASSWORD) {
                        // 登录成功
                        adminLoginModal.style.display = 'none';
                        adminContainer.style.display = 'block';
                        
                        // 加载初始数据
                        loadDashboardStats();
                        loadAnnouncement();
                        
                        showMessage('登录成功', 'success');
                    } else {
                        showMessage('密码错误', 'error');
                    }
                });
                
                // 退出登录
                logoutBtn.addEventListener('click', function() {
                    adminContainer.style.display = 'none';
                    adminLoginModal.style.display = 'flex';
                    adminPassword.value = '';
                });
                
                // 生成卡密
                generateKeyBtn.addEventListener('click', function() {
                    const keyValue = keyValueInput.value.trim();
                    const keyDays = parseInt(keyDaysInput.value);
                    const keyHours = parseInt(keyHoursInput.value);
                    const keyMinutes = parseInt(keyMinutesInput.value);
                    const usageCount = parseInt(keyUsageCountInput.value);
                    
                    if (!keyValue) {
                        showMessage('请输入卡密内容', 'error');
                        return;
                    }
                    
                    if (isNaN(keyDays) || keyDays < 0) {
                        showMessage('有效天数必须是非负整数', 'error');
                        return;
                    }
                    
                    if (isNaN(keyHours) || keyHours < 0 || keyHours > 23) {
                        showMessage('有效小时必须是0-23的整数', 'error');
                        return;
                    }
                    
                    if (isNaN(keyMinutes) || keyMinutes < 0 || keyMinutes > 59) {
                        showMessage('有效分钟必须是0-59的整数', 'error');
                        return;
                    }
                    
                    if (keyDays === 0 && keyHours === 0 && keyMinutes === 0) {
                        showMessage('有效期必须大于0', 'error');
                        return;
                    }
                    
                    if (isNaN(usageCount) || usageCount <= 0) {
                        showMessage('使用次数必须是大于0的整数', 'error');
                        return;
                    }
                    
                    // 检查卡密是否已存在
                    const existingKey = keysDatabase.find(k => k.key === keyValue);
                    if (existingKey) {
                        showMessage('卡密已存在，请使用其他内容', 'error');
                        return;
                    }
                    
                    // 创建卡密对象
                    const key = {
                        id: Date.now().toString(),
                        key: keyValue,
                        validityDays: keyDays,
                        validityHours: keyHours,
                        validityMinutes: keyMinutes,
                        remainingUses: usageCount,
                        totalUses: usageCount,
                        status: 'active',
                        firstUsedAt: null, // 新增字段，记录首次使用时间
                        createdAt: new Date().toISOString(),
                        updatedAt: new Date().toISOString()
                    };
                    
                    // 保存到数据库
                    keysDatabase.push(key);
                    saveData();
                    
                    // 清空输入框
                    keyValueInput.value = '';
                    
                    // 重新加载卡密列表
                    loadKeys();
                    loadDashboardStats();
                    
                    showMessage('卡密生成成功', 'success');
                });
                
                // 批量生成随机卡密
                generateRandomKeysBtn.addEventListener('click', function() {
                    const count = parseInt(randomKeyCountInput.value);
                    const length = parseInt(randomKeyLengthInput.value);
                    
                    if (isNaN(count) || count <= 0) {
                        showMessage('生成数量必须是大于0的整数', 'error');
                        return;
                    }
                    
                    if (isNaN(length) || length < 4) {
                        showMessage('卡密长度必须至少为4位', 'error');
                        return;
                    }
                    
                    const keyDays = parseInt(keyDaysInput.value);
                    const keyHours = parseInt(keyHoursInput.value);
                    const keyMinutes = parseInt(keyMinutesInput.value);
                    const usageCount = parseInt(keyUsageCountInput.value);
                    
                    // 生成随机卡密
                    const keys = [];
                    for (let i = 0; i < count; i++) {
                        const randomKey = generateRandomKey(length);
                        keys.push({
                            id: (Date.now() + i).toString(),
                            key: randomKey,
                            validityDays: keyDays,
                            validityHours: keyHours,
                            validityMinutes: keyMinutes,
                            remainingUses: usageCount,
                            totalUses: usageCount,
                            status: 'active',
                            firstUsedAt: null, // 新增字段，记录首次使用时间
                            createdAt: new Date().toISOString(),
                            updatedAt: new Date().toISOString()
                        });
                    }
                    
                    // 保存到数据库
                    keysDatabase.push(...keys);
                    saveData();
                    
                    // 重新加载卡密列表
                    loadKeys();
                    loadDashboardStats();
                    
                    showMessage(`成功生成 ${count} 个随机卡密`, 'success');
                });
                
                // 查询卡密
                searchKeyBtn.addEventListener('click', function() {
                    const searchKey = searchKeyInput.value.trim();
                    if (searchKey) {
                        loadKeys(searchKey);
                    } else {
                        loadKeys();
                    }
                });
                
                // 导出卡密
                exportKeysBtn.addEventListener('click', function() {
                    exportKeysToCSV();
                });
                
                // 筛选状态变化
                filterStatusSelect.addEventListener('change', function() {
                    loadKeys();
                });
                
                // 删除已过期卡密
                deleteExpiredBtn.addEventListener('click', function() {
                    if (!confirm('确定要删除所有已过期卡密吗？此操作不可恢复！')) {
                        return;
                    }
                    
                    const now = new Date();
                    const initialCount = keysDatabase.length;
                    keysDatabase = keysDatabase.filter(key => {
                        // 计算卡密状态
                        const status = calculateKeyStatus(key);
                        return status !== 'expired';
                    });
                    
                    saveData();
                    
                    loadKeys();
                    loadDashboardStats();
                    
                    const deletedCount = initialCount - keysDatabase.length;
                    showMessage(`已删除 ${deletedCount} 个过期卡密`, 'success');
                });
                
                // 清理已使用卡密
                clearUsedBtn.addEventListener('click', function() {
                    if (!confirm('确定要清理所有已使用卡密吗？此操作不可恢复！')) {
                        return;
                    }
                    
                    const initialCount = keysDatabase.length;
                    keysDatabase = keysDatabase.filter(key => {
                        const status = calculateKeyStatus(key);
                        return status !== 'used';
                    });
                    saveData();
                    
                    loadKeys();
                    loadDashboardStats();
                    
                    const deletedCount = initialCount - keysDatabase.length;
                    showMessage(`已清理 ${deletedCount} 个已使用卡密`, 'success');
                });
                
                // 保存公告
                saveAnnouncementBtn.addEventListener('click', function() {
                    const content = announcementContent.value.trim();
                    
                    if (!content) {
                        showMessage('请输入公告内容', 'error');
                        return;
                    }
                    
                    announcementsDatabase = [{
                        id: 1,
                        content: content,
                        createdAt: new Date().toISOString()
                    }];
                    saveData();
                    
                    showMessage('公告保存成功', 'success');
                });
                
                // 刷新统计
                refreshStatsBtn.addEventListener('click', function() {
                    loadDashboardStats();
                    showMessage('统计数据已刷新', 'success');
                });
                
                // 备份数据
                backupDataBtn.addEventListener('click', function() {
                    exportKeysToCSV();
                });
                
                // 密码输入框回车键事件
                adminPassword.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        adminLoginBtn.click();
                    }
                });
            }
            
            // 计算卡密状态
            function calculateKeyStatus(key) {
                // 如果已使用次数为0，标记为已使用
                if (key.remainingUses === 0) {
                    return 'used';
                }
                
                // 如果从未被使用过，则为未使用状态
                if (key.firstUsedAt === null) {
                    return 'unused';
                }
                
                // 计算到期时间
                const firstUsedDate = new Date(key.firstUsedAt);
                const expiryDate = new Date(firstUsedDate);
                expiryDate.setDate(expiryDate.getDate() + key.validityDays);
                expiryDate.setHours(expiryDate.getHours() + key.validityHours);
                expiryDate.setMinutes(expiryDate.getMinutes() + key.validityMinutes);
                
                // 检查是否过期
                const now = new Date();
                if (now > expiryDate) {
                    return 'expired';
                }
                
                return 'active';
            }
            
            // 计算卡密剩余时间
            function calculateRemainingTime(key) {
                // 如果从未被使用过，返回完整有效期
                if (key.firstUsedAt === null) {
                    return {
                        days: key.validityDays,
                        hours: key.validityHours,
                        minutes: key.validityMinutes,
                        isUsed: false
                    };
                }
                
                // 计算到期时间
                const firstUsedDate = new Date(key.firstUsedAt);
                const expiryDate = new Date(firstUsedDate);
                expiryDate.setDate(expiryDate.getDate() + key.validityDays);
                expiryDate.setHours(expiryDate.getHours() + key.validityHours);
                expiryDate.setMinutes(expiryDate.getMinutes() + key.validityMinutes);
                
                // 计算剩余时间
                const now = new Date();
                const diff = expiryDate - now;
                
                if (diff <= 0) {
                    return {
                        days: 0,
                        hours: 0,
                        minutes: 0,
                        isUsed: true,
                        isExpired: true
                    };
                }
                
                const days = Math.floor(diff / (1000 * 60 * 60 * 24));
                const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
                
                return {
                    days,
                    hours,
                    minutes,
                    isUsed: true
                };
            }
            
            // 加载数据看板统计
            function loadDashboardStats() {
                const now = new Date();
                
                // 计算各种状态的卡密数量
                const totalKeys = keysDatabase.length;
                let activeKeys = 0;
                let usedKeys = 0;
                let expiredKeys = 0;
                
                keysDatabase.forEach(key => {
                    const status = calculateKeyStatus(key);
                    if (status === 'active') activeKeys++;
                    if (status === 'used') usedKeys++;
                    if (status === 'expired') expiredKeys++;
                });
                
                // 更新显示
                totalKeysSpan.textContent = totalKeys;
                activeKeysSpan.textContent = activeKeys;
                usedKeysSpan.textContent = usedKeys;
                expiredKeysSpan.textContent = expiredKeys;
                
                // 更新最后更新时间
                lastUpdateSpan.textContent = new Date().toLocaleString();
                
                // 加载近期使用记录
                loadRecentUsage();
            }
            
            // 加载近期使用记录
            function loadRecentUsage() {
                recentUsageContainer.innerHTML = '';
                
                // 获取最近10条使用记录
                const recentLogs = usageLogs.slice(-10).reverse();
                
                if (recentLogs.length > 0) {
                    recentLogs.forEach(log => {
                        const key = keysDatabase.find(k => k.id === log.keyId);
                        if (key) {
                            const logItem = document.createElement('div');
                            logItem.className = 'key-item';
                            
                            const logInfo = document.createElement('div');
                            logInfo.className = 'key-info';
                            
                            const logValue = document.createElement('div');
                            logValue.className = 'key-value';
                            logValue.textContent = key.key;
                            
                            const logDetails = document.createElement('div');
                            logDetails.className = 'key-details';
                            logDetails.textContent = `使用时间: ${new Date(log.usedAt).toLocaleString()}`;
                            
                            logInfo.appendChild(logValue);
                            logInfo.appendChild(logDetails);
                            logItem.appendChild(logInfo);
                            
                            recentUsageContainer.appendChild(logItem);
                        }
                    });
                } else {
                    recentUsageContainer.innerHTML = '<div style="text-align: center; padding: 20px; color: var(--gray);">暂无使用记录</div>';
                }
            }
            
            // 加载卡密列表
            function loadKeys(searchKey = '') {
                let filteredKeys = [...keysDatabase];
                
                // 应用搜索条件
                if (searchKey) {
                    filteredKeys = filteredKeys.filter(key => 
                        key.key.toLowerCase().includes(searchKey.toLowerCase())
                    );
                }
                
                // 应用状态筛选
                const filterStatus = filterStatusSelect.value;
                if (filterStatus !== 'all') {
                    filteredKeys = filteredKeys.filter(key => {
                        const status = calculateKeyStatus(key);
                        return status === filterStatus;
                    });
                }
                
                // 按创建时间排序
                filteredKeys.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
                
                keysContainer.innerHTML = '';
                
                if (filteredKeys.length > 0) {
                    filteredKeys.forEach(key => {
                        const keyItem = document.createElement('div');
                        keyItem.className = 'key-item';
                        
                        const keyInfo = document.createElement('div');
                        keyInfo.className = 'key-info';
                        
                        const keyValue = document.createElement('div');
                        keyValue.className = 'key-value';
                        keyValue.textContent = key.key;
                        
                        const keyDetails = document.createElement('div');
                        keyDetails.className = 'key-details';
                        
                        // 计算卡密状态
                        const status = calculateKeyStatus(key);
                        const remainingTime = calculateRemainingTime(key);
                        
                        let statusText = '';
                        if (status === 'used') {
                            statusText = '已使用';
                        } else if (status === 'expired') {
                            statusText = '已过期';
                        } else if (status === 'unused') {
                            statusText = '未使用';
                        } else {
                            statusText = '可用';
                        }
                        
                        // 构建显示信息
                        let timeInfo = '';
                        if (status === 'unused') {
                            timeInfo = `有效期: ${key.validityDays}天${key.validityHours}小时${key.validityMinutes}分钟`;
                        } else if (status === 'active') {
                            timeInfo = `剩余时间: ${remainingTime.days}天${remainingTime.hours}小时${remainingTime.minutes}分钟`;
                        } else if (status === 'expired') {
                            timeInfo = '已过期';
                        }
                        
                        keyDetails.innerHTML = `
                            ${timeInfo} | 
                            剩余次数: ${key.remainingUses}/${key.totalUses} | 
                            状态: ${statusText}
                        `;
                        
                        keyInfo.appendChild(keyValue);
                        keyInfo.appendChild(keyDetails);
                        
                        const keyActions = document.createElement('div');
                        keyActions.className = 'key-actions';
                        
                        const deleteBtn = document.createElement('button');
                        deleteBtn.className = 'delete-btn';
                        deleteBtn.textContent = '删除';
                        deleteBtn.addEventListener('click', function() {
                            deleteKey(key.id);
                        });
                        
                        keyActions.appendChild(deleteBtn);
                        
                        keyItem.appendChild(keyInfo);
                        keyItem.appendChild(keyActions);
                        
                        keysContainer.appendChild(keyItem);
                    });
                } else {
                    keysContainer.innerHTML = '<div style="text-align: center; padding: 20px; color: var(--gray);">暂无卡密</div>';
                }
            }
            
            // 加载公告
            function loadAnnouncement() {
                if (announcementsDatabase.length > 0) {
                    announcementContent.value = announcementsDatabase[0].content;
                }
            }
            
            // 删除卡密
            function deleteKey(keyId) {
                if (!confirm('确定要删除这个卡密吗？此操作不可恢复！')) {
                    return;
                }
                
                keysDatabase = keysDatabase.filter(key => key.id !== keyId);
                saveData();
                
                loadKeys();
                loadDashboardStats();
                
                showMessage('卡密删除成功', 'success');
            }
            
            // 导出卡密到CSV
            function exportKeysToCSV() {
                if (keysDatabase.length === 0) {
                    showMessage('没有卡密数据可导出', 'error');
                    return;
                }
                
                // 创建CSV内容
                let csvContent = '卡密,有效期(天),有效期(小时),有效期(分钟),总次数,剩余次数,状态,创建时间\n';
                
                keysDatabase.forEach(key => {
                    const status = calculateKeyStatus(key);
                    csvContent += `"${key.key}","${key.validityDays}","${key.validityHours}","${key.validityMinutes}","${key.totalUses}","${key.remainingUses}","${status}","${new Date(key.createdAt).toLocaleString()}"\n`;
                });
                
                // 创建下载链接
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.setAttribute('href', url);
                link.setAttribute('download', `卡密备份_${new Date().toISOString().split('T')[0]}.csv`);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                showMessage('卡密数据导出成功', 'success');
            }
            
            // 生成随机卡密
            function generateRandomKey(length) {
                const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
                let result = '';
                for (let i = 0; i < length; i++) {
                    result += chars.charAt(Math.floor(Math.random() * chars.length));
                }
                return result;
            }
            
            // 显示消息
            function showMessage(message, type) {
                adminLoginMessage.textContent = message;
                adminLoginMessage.className = `message ${type}`;
                adminLoginMessage.style.display = 'block';
                
                setTimeout(() => {
                    adminLoginMessage.style.display = 'none';
                }, 3000);
            }
            
            // 初始化应用
            init();
        });
    </script>
</body>
    </html>

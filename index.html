<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>斩的快手转发</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root {
            --primary: #ff6b6b;
            --secondary: #4ecdc4;
            --accent: #ff9f43;
            --dark: #0a0a0a;
            --darker: #050505;
            --light: #f1f2f6;
            --gray: #a4b0be;
            --success: #2ed573;
            --warning: #ffa502;
            --error: #ff4757;
            --card-bg: rgba(20, 20, 20, 0.8);
            --card-border: rgba(255, 255, 255, 0.1);
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Arial, sans-serif;
        }
        
        body {
            background: var(--darker);
            color: white;
            min-height: 100vh;
            overflow-x: hidden;
        }
        
        /* 动态背景效果 */
        .bg-animation {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            opacity: 0.4;
        }
        
        .bg-circle {
            position: absolute;
            border-radius: 50%;
            background: radial-gradient(circle, var(--primary) 0%, transparent 70%);
            animation: float 15s infinite linear;
        }
        
        .bg-circle:nth-child(1) {
            width: 300px;
            height: 300px;
            top: 10%;
            left: 5%;
            animation-delay: 0s;
        }
        
        .bg-circle:nth-child(2) {
            width: 200px;
            height: 200px;
            top: 60%;
            left: 80%;
            animation-delay: 5s;
        }
        
        .bg-circle:nth-child(3) {
            width: 400px;
            height: 400px;
            top: 30%;
            left: 60%;
            animation-delay: 10s;
        }
        
        @keyframes float {
            0% {
                transform: translate(0, 0) rotate(0deg);
            }
            33% {
                transform: translate(30px, -50px) rotate(120deg);
            }
            66% {
                transform: translate(-20px, 20px) rotate(240deg);
            }
            100% {
                transform: translate(0, 0) rotate(360deg);
            }
        }
        
        /* 主容器 */
        .container {
            width: 100%;
            max-width: 100%;
            margin: 0 auto;
            background: rgba(10, 10, 10, 0.8);
            min-height: 100vh;
            padding-bottom: 70px;
            display: none;
            position: relative;
            z-index: 1;
        }
        
        /* 头部 */
        .header {
            text-align: center;
            padding: 20px;
            padding-top: 40px;
            padding-bottom: 20px;
            border-bottom: 1px solid var(--card-border);
            position: relative;
            background: rgba(10, 10, 10, 0.9);
        }
        
        .header::after {
            content: '';
            position: absolute;
            bottom: -1px;
            left: 50%;
            transform: translateX(-50%);
            width: 100px;
            height: 3px;
            background: linear-gradient(90deg, transparent, var(--primary), transparent);
        }
        
        .header h1 {
            font-size: 28px;
            margin-bottom: 5px;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            font-weight: 700;
            text-shadow: 0 0 10px rgba(255, 107, 107, 0.3);
        }
        
        .header p {
            color: var(--gray);
            font-size: 14px;
        }
        
        /* 页面内容 */
        .page {
            display: none;
            padding: 20px;
            animation: fadeIn 0.5s ease-in-out;
        }
        
        .page.active {
            display: block;
        }
        
        /* 面板样式 */
        .panel {
            background: var(--card-bg);
            border-radius: 15px;
            padding: 20px;
            border: 1px solid var(--card-border);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
            margin-bottom: 20px;
            transition: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            backdrop-filter: blur(10px);
        }
        
        .panel:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 30px rgba(0, 0, 0, 0.4);
        }
        
        .panel h2 {
            margin-bottom: 15px;
            color: var(--secondary);
            border-bottom: 1px solid var(--card-border);
            padding-bottom: 10px;
            display: flex;
            align-items: center;
            font-size: 18px;
        }
        
        .panel h2 i {
            margin-right: 10px;
            color: var(--primary);
            font-size: 16px;
        }
        
        /* 输入组 */
        .input-group {
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: var(--light);
            font-size: 14px;
        }
        
        input, textarea, select {
            width: 100%;
            padding: 12px;
            border-radius: 8px;
            border: 1px solid var(--card-border);
            background: rgba(30, 30, 30, 0.7);
            color: white;
            font-size: 16px;
            transition: all 0.3s;
        }
        
        textarea {
            min-height: 100px;
            resize: vertical;
        }
        
        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 2px rgba(255, 107, 107, 0.2);
        }
        
        input::placeholder, textarea::placeholder {
            color: rgba(255, 255, 255, 0.4);
        }
        
        /* 按钮组 */
        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        
        button {
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            font-size: 16px;
            position: relative;
            overflow: hidden;
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        button::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s;
        }
        
        button:hover::before {
            left: 100%;
        }
        
        .primary-btn {
            background: linear-gradient(135deg, var(--primary), #ff5252);
            color: white;
        }
        
        .primary-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 107, 107, 0.4);
        }
        
        .primary-btn:disabled {
            background: var(--gray);
            cursor: not-allowed;
        }
        
        .secondary-btn {
            background: rgba(255, 255, 255, 0.05);
            color: var(--light);
            border: 1px solid var(--card-border);
        }
        
        .secondary-btn:hover:not(:disabled) {
            background: rgba(255, 255, 255, 0.1);
        }
        
        .accent-btn {
            background: linear-gradient(135deg, var(--accent), #ff7e00);
            color: white;
        }
        
        .accent-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 159, 67, 0.4);
        }
        
        .start-btn {
            background: linear-gradient(135deg, var(--primary), #ff5252);
            color: white;
        }
        
        .start-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 107, 107, 0.4);
        }
        
        .start-btn:disabled {
            background: var(--gray);
            cursor: not-allowed;
        }
        
        .stop-btn {
            background: linear-gradient(135deg, var(--secondary), #26a69a);
            color: white;
        }
        
        .stop-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(78, 205, 196, 0.4);
        }
        
        .stop-btn:disabled {
            background: var(--gray);
            cursor: not-allowed;
        }
        
        /* 进度容器 */
        .progress-container {
            margin-top: 25px;
            background: var(--card-bg);
            border-radius: 15px;
            padding: 20px;
            display: none;
            border: 1px solid var(--card-border);
            animation: slideIn 0.5s ease-out;
        }
        
        .progress-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 15px;
            font-size: 16px;
        }
        
        .progress-bar {
            height: 12px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 6px;
            overflow: hidden;
            margin-bottom: 20px;
            position: relative;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            border-radius: 6px;
            width: 0%;
            transition: width 0.5s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            position: relative;
            overflow: hidden;
        }
        
        .progress-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            animation: shimmer 2s infinite;
        }
        
        @keyframes shimmer {
            0% {
                left: -100%;
            }
            100% {
                left: 100%;
            }
        }
        
        /* 统计信息 */
        .stats {
            display: flex;
            justify-content: space-between;
            text-align: center;
        }
        
        .stat-box {
            flex: 1;
            padding: 10px;
            background: rgba(30, 30, 30, 0.5);
            border-radius: 8px;
            margin: 0 5px;
            border: 1px solid var(--card-border);
            transition: transform 0.3s;
        }
        
        .stat-box:hover {
            transform: translateY(-3px);
        }
        
        .stat-value {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .success {
            color: var(--success);
            text-shadow: 0 0 5px rgba(46, 213, 115, 0.5);
        }
        
        .error {
            color: var(--error);
            text-shadow: 0 0 5px rgba(255, 71, 87, 0.5);
        }
        
        /* 日志容器 */
        .logs-container {
            margin-top: 30px;
            background: var(--card-bg);
            border-radius: 15px;
            padding: 20px;
            display: none;
            border: 1px solid var(--card-border);
            animation: slideIn 0.5s ease-out;
        }
        
        .logs-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .logs {
            max-height: 300px;
            overflow-y: auto;
        }
        
        .log-entry {
            padding: 10px 0;
            border-bottom: 1px solid var(--card-border);
            font-size: 14px;
            display: flex;
            align-items: center;
            animation: fadeIn 0.3s;
        }
        
        .log-entry:last-child {
            border-bottom: none;
        }
        
        .log-icon {
            margin-right: 10px;
            font-size: 16px;
        }
        
        .log-success {
            color: var(--success);
        }
        
        .log-error {
            color: var(--error);
        }
        
        /* 信息框 */
        .info-box {
            background: rgba(30, 30, 30, 0.5);
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
            display: none;
            border: 1px solid var(--card-border);
        }
        
        .info-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }
        
        .info-row:last-child {
            margin-bottom: 0;
        }
        
        /* 用户信息 */
        .user-info {
            margin-top: 15px;
        }
        
        .info-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 15px;
            padding: 12px 0;
            border-bottom: 1px solid var(--card-border);
        }
        
        .info-item:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }
        
        .label {
            font-weight: bold;
            color: var(--light);
        }
        
        .value {
            color: var(--secondary);
        }
        
        /* 音乐播放器 */
        .music-player {
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px solid var(--card-border);
        }
        
        .music-player h3 {
            margin-bottom: 10px;
            color: var(--secondary);
            display: flex;
            align-items: center;
        }
        
        .music-player h3 i {
            margin-right: 8px;
        }
        
        .player-controls {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .music-btn {
            background: var(--warning);
            color: white;
            padding: 8px 15px;
            font-size: 14px;
            border-radius: 6px;
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
        }
        
        .music-btn:hover {
            background: #e69500;
            transform: translateY(-2px);
        }
        
        /* 代理设置 */
        .proxy-settings {
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px solid var(--card-border);
        }
        
        .proxy-settings h3 {
            margin-bottom: 10px;
            color: var(--secondary);
            display: flex;
            align-items: center;
        }
        
        .proxy-settings h3 i {
            margin-right: 8px;
        }
        
        /* 状态消息 */
        .status {
            text-align: center;
            margin-top: 15px;
            padding: 10px;
            border-radius: 8px;
            display: none;
        }
        
        .status-success {
            background: rgba(46, 213, 115, 0.1);
            color: var(--success);
            border: 1px solid rgba(46, 213, 115, 0.2);
        }
        
        .status-error {
            background: rgba(255, 71, 87, 0.1);
            color: var(--error);
            border: 1px solid rgba(255, 71, 87, 0.2);
        }
        
        .message {
            margin-top: 10px;
            padding: 10px;
            border-radius: 5px;
            text-align: center;
            display: none;
        }
        
        .message.success {
            background: rgba(46, 213, 115, 0.1);
            color: var(--success);
            border: 1px solid rgba(46, 213, 115, 0.2);
        }
        
        .message.error {
            background: rgba(255, 71, 87, 0.1);
            color: var(--error);
            border: 1px solid rgba(255, 71, 87, 0.2);
        }
        
        /* 底部导航 */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background: rgba(10, 10, 10, 0.95);
            backdrop-filter: blur(10px);
            border-top: 1px solid var(--card-border);
            display: flex;
            z-index: 1000;
            padding: 10px 0;
        }
        
        .nav-item {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 8px 0;
            color: var(--gray);
            text-decoration: none;
            transition: all 0.3s;
        }
        
        .nav-item.active {
            color: var(--primary);
        }
        
        .nav-icon {
            font-size: 20px;
            margin-bottom: 4px;
        }
        
        .nav-text {
            font-size: 12px;
        }
        
        /* 模态框样式 */
        .modal {
            display: flex;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.9);
            align-items: center;
            justify-content: center;
        }
        
        .modal-content {
            background: rgba(20, 20, 20, 0.95);
            border-radius: 20px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.6);
            overflow: hidden;
            border: 1px solid var(--card-border);
            animation: modalAppear 0.5s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            backdrop-filter: blur(15px);
        }
        
        @keyframes modalAppear {
            from {
                opacity: 0;
                transform: scale(0.9) translateY(-20px);
            }
            to {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }
        
        .modal-header {
            padding: 20px;
            background: rgba(30, 30, 30, 0.7);
            border-bottom: 1px solid var(--card-border);
            text-align: center;
        }
        
        .modal-header h2 {
            color: var(--secondary);
            margin: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .modal-body {
            padding: 20px;
        }
        
        .announcement-content {
            max-width: 600px;
        }
        
        .announcement-text {
            background: rgba(30, 30, 30, 0.5);
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            line-height: 1.6;
            font-size: 16px;
            color: white;
            border: 1px solid var(--card-border);
            position: relative;
            overflow: hidden;
        }
        
        .announcement-text::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 5px;
            height: 100%;
            background: var(--primary);
        }
        
        .buy-card-link {
            display: block;
            text-align: center;
            margin-top: 15px;
            color: var(--accent);
            text-decoration: none;
            font-weight: bold;
            transition: color 0.3s;
        }
        
        .buy-card-link:hover {
            color: #ff7e00;
            text-decoration: underline;
        }
        
        .footer {
            text-align: center;
            margin-top: 30px;
            color: var(--gray);
            font-size: 14px;
            padding: 20px;
            border-top: 1px solid var(--card-border);
        }
        
        /* 动画效果 */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        @keyframes slideIn {
            from { opacity: 0; transform: translateX(-20px); }
            to { opacity: 1; transform: translateX(0); }
        }
        
        /* 响应式设计 */
        @media (max-width: 768px) {
            .button-group {
                flex-direction: column;
            }
            
            .stats {
                flex-direction: column;
                gap: 10px;
            }
            
            .stat-box {
                margin: 0;
            }
            
            .player-controls {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <!-- 动态背景 -->
    <div class="bg-animation">
        <div class="bg-circle"></div>
        <div class="bg-circle"></div>
        <div class="bg-circle"></div>
    </div>

    <!-- 卡密验证弹窗 -->
    <div id="keyModal" class="modal" style="display: flex;">
        <div class="modal-content">
            <div class="modal-header">
                <h2><i class="fas fa-key"></i> 卡密验证</h2>
            </div>
            <div class="modal-body">
                <div class="input-group">
                    <label for="keyInput">请输入卡密</label>
                    <input type="text" id="keyInput" placeholder="输入您的卡密...">
                </div>
                <div class="button-group">
                    <button id="verifyKeyBtn" class="primary-btn"><i class="fas fa-check"></i> 验证卡密</button>
                </div>
                <a href="https://yka.ymyfak.com/links/64109ECB" target="_blank" class="buy-card-link">
                    <i class="fas fa-shopping-cart"></i> 购买卡密
                </a>
                <div id="keyMessage" class="message"></div>
            </div>
        </div>
    </div>

    <!-- 公告弹窗 -->
    <div id="announcementModal" class="modal" style="display: none;">
        <div class="modal-content announcement-content">
            <div class="modal-header">
                <h2><i class="fas fa-bullhorn"></i> 系统公告</h2>
            </div>
            <div class="modal-body">
                <div id="announcementText" class="announcement-text">
                    <!-- 公告内容将通过JavaScript动态加载 -->
                </div>
                <div class="button-group">
                    <button id="confirmAnnouncementBtn" class="primary-btn"><i class="fas fa-check"></i> 确定</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 主界面 -->
    <div class="container" id="mainContainer">
        <div class="header">
            <h1>快手转发工具</h1>
            <p>快速提升快手作品转发量</p>
        </div>
        
        <!-- 首页 -->
        <div class="page active" id="home-page">
            <div class="panel">
                <h2><i class="fas fa-share-alt"></i> 分享设置</h2>
                <div class="input-group">
                    <label for="videoUrl">快手作品链接</label>
                    <input type="text" id="videoUrl" placeholder="https://v.kuaishou.com/...">
                </div>
                
                <div class="input-group">
                    <label for="shareCount">分享次数</label>
                    <input type="number" id="shareCount" value="100" min="1" max="1000">
                </div>
                
                <div class="input-group">
                    <label for="concurrentCount">并发数量</label>
                    <input type="number" id="concurrentCount" value="5" min="1" max="20">
                </div>
                
                <div class="button-group">
                    <button class="start-btn" id="startBtn"><i class="fas fa-play"></i> 开始分享</button>
                    <button class="stop-btn" id="stopBtn" disabled><i class="fas fa-stop"></i> 停止分享</button>
                </div>
                
                <div class="status" id="statusMessage"></div>
                
                <div class="info-box" id="infoBox">
                    <div class="info-row">
                        <span>作者ID:</span>
                        <span id="authorId">-</span>
                    </div>
                    <div class="info-row">
                        <span>作品ID:</span>
                        <span id="photoId">-</span>
                    </div>
                    <div class="info-row">
                        <span>解析方法:</span>
                        <span id="parseMethod">-</span>
                    </div>
                </div>
            </div>
            
            <div class="progress-container" id="progressContainer">
                <div class="progress-header">
                    <span>分享进度</span>
                    <span id="progressText">0/0</span>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
                <div class="stats">
                    <div class="stat-box">
                        <div class="stat-value success" id="successCount">0</div>
                        <div>成功</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value error" id="errorCount">0</div>
                        <div>失败</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value" id="speed">0</div>
                        <div>次/秒</div>
                    </div>
                </div>
            </div>
            
            <div class="logs-container">
                <div class="logs-header">
                    <h3><i class="fas fa-list"></i> 实时日志</h3>
                    <button id="clearLogsBtn" class="secondary-btn"><i class="fas fa-trash"></i> 清空日志</button>
                </div>
                <div class="logs" id="logsContainer">
                    <!-- 日志将在这里显示 -->
                </div>
            </div>
        </div>
        
        <!-- 我的页面 -->
        <div class="page" id="profile-page">
            <div class="panel">
                <h2><i class="fas fa-user"></i> 用户信息</h2>
                <div class="user-info">
                    <div class="info-item">
                        <span class="label">卡密状态:</span>
                        <span class="value" id="keyStatus">未验证</span>
                    </div>
                    <div class="info-item">
                        <span class="label">剩余次数:</span>
                        <span class="value" id="remainingCount">0</span>
                    </div>
                    <div class="info-item">
                        <span class="label">有效期至:</span>
                        <span class="value" id="expiryDate">-</span>
                    </div>
                    <div class="info-item">
                        <span class="label">剩余时间:</span>
                        <span class="value" id="remainingTime">-</span>
                    </div>
                </div>
                
                <div class="proxy-settings">
                    <h3><i class="fas fa-server"></i> 代理设置</h3>
                    <div class="input-group">
                        <label for="proxyUrl">代理地址 (可选)</label>
                        <input type="text" id="proxyUrl" placeholder="例如: https://cors-anywhere.herokuapp.com/">
                    </div>
                </div>
                
                <div class="music-player">
                    <h3><i class="fas fa-music"></i> 背景音乐</h3>
                    <div class="player-controls">
                        <button id="playBtn" class="music-btn"><i class="fas fa-play"></i> 播放</button>
                        <button id="pauseBtn" class="music-btn"><i class="fas fa-pause"></i> 暂停</button>
                        <button id="volumeUpBtn" class="music-btn"><i class="fas fa-volume-up"></i> 音量+</button>
                        <button id="volumeDownBtn" class="music-btn"><i class="fas fa-volume-down"></i> 音量-</button>
                    </div>
                    <audio id="bgMusic" loop>
                        <source src="https://music.163.com/song/media/outer/url?id=2759391353.mp3" type="audio/mpeg">
                        您的浏览器不支持音频元素
                    </audio>
                </div>
            </div>
            
            <div class="panel">
                <h2><i class="fas fa-info-circle"></i> 系统信息</h2>
                <div class="user-info">
                    <div class="info-item">
                        <span class="label">系统版本:</span>
                        <span class="value">2.0</span>
                    </div>
                    <div class="info-item">
                        <span class="label">最后更新:</span>
                        <span class="value">2025-11-21</span>
                    </div>
                    <div class="info-item">
                        <span class="label">开发者:</span>
                        <span class="value">快手4907913227</span>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="footer">
            <p>快手转发 &copy; 2025 | 版本 2.0</p>
        </div>
    </div>

    <!-- 底部导航 -->
    <div class="bottom-nav">
        <div class="nav-item active" data-page="home-page">
            <div class="nav-icon"><i class="fas fa-home"></i></div>
            <div class="nav-text">首页</div>
        </div>
        <div class="nav-item" data-page="profile-page">
            <div class="nav-icon"><i class="fas fa-user"></i></div>
            <div class="nav-text">我的</div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Supabase配置 - 使用匿名密钥（前端权限）
            const SUPABASE_URL = 'https://wgqungehwqjfkymgzhgc.supabase.co';
            const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndncXVuZ2Vod3FqZmt5bWd6aGdjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM2NzAxMDYsImV4cCI6MjA3OTI0NjEwNn0.R1lwxpSlOOfFS7HJIpJnPtaSZoOutcL-zNPB_xmmg0s';
            
            // 初始化Supabase客户端
            const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
            
            // 元素引用
            const keyModal = document.getElementById('keyModal');
            const announcementModal = document.getElementById('announcementModal');
            const mainContainer = document.getElementById('mainContainer');
            const keyInput = document.getElementById('keyInput');
            const verifyKeyBtn = document.getElementById('verifyKeyBtn');
            const keyMessage = document.getElementById('keyMessage');
            const announcementText = document.getElementById('announcementText');
            const confirmAnnouncementBtn = document.getElementById('confirmAnnouncementBtn');
            
            const videoUrlInput = document.getElementById('videoUrl');
            const shareCountInput = document.getElementById('shareCount');
            const concurrentCountInput = document.getElementById('concurrentCount');
            const startBtn = document.getElementById('startBtn');
            const stopBtn = document.getElementById('stopBtn');
            const infoBox = document.getElementById('infoBox');
            const authorIdSpan = document.getElementById('authorId');
            const photoIdSpan = document.getElementById('photoId');
            const parseMethodSpan = document.getElementById('parseMethod');
            const keyStatusSpan = document.getElementById('keyStatus');
            const remainingCountSpan = document.getElementById('remainingCount');
            const expiryDateSpan = document.getElementById('expiryDate');
            const remainingTimeSpan = document.getElementById('remainingTime');
            const progressContainer = document.getElementById('progressContainer');
            const progressFill = document.getElementById('progressFill');
            const progressText = document.getElementById('progressText');
            const successCountSpan = document.getElementById('successCount');
            const errorCountSpan = document.getElementById('errorCount');
            const speedSpan = document.getElementById('speed');
            const logsContainer = document.getElementById('logsContainer');
            const clearLogsBtn = document.getElementById('clearLogsBtn');
            const statusMessage = document.getElementById('statusMessage');
            const playBtn = document.getElementById('playBtn');
            const pauseBtn = document.getElementById('pauseBtn');
            const volumeUpBtn = document.getElementById('volumeUpBtn');
            const volumeDownBtn = document.getElementById('volumeDownBtn');
            const bgMusic = document.getElementById('bgMusic');
            const proxyUrlInput = document.getElementById('proxyUrl');
            
            // 导航元素
            const navItems = document.querySelectorAll('.nav-item');
            const pages = document.querySelectorAll('.page');
            
            // 状态变量
            let isRunning = false;
            let totalRequests = 0;
            let successCount = 0;
            let errorCount = 0;
            let startTime = 0;
            let currentRequestCount = 0;
            let currentKey = null;
            let abortController = null;
            let remainingTimeInterval = null;
            
            // 解析器列表 - 浏览器兼容版本
            const parsers = [
                {
                    name: "本地重定向解析",
                    method: parseWithRedirect
                },
                {
                    name: "UOMG短链接还原",
                    method: parseWithUomgService
                },
                {
                    name: "PFAN短链接还原",
                    method: parseWithPfanService
                },
                {
                    name: "直接解析",
                    method: parseDirectly
                },
                {
                    name: "备用方法",
                    method: parseWithFallback
                }
            ];
            
            // 初始化
            function init() {
                console.log('初始化应用...');
                
                // 显示卡密验证弹窗
                keyModal.style.display = 'flex';
                mainContainer.style.display = 'none';
                
                // 加载公告
                loadAnnouncement();
                
                // 设置音乐播放器
                setupMusicPlayer();
                
                // 加载代理设置
                loadProxySettings();
                
                // 设置导航
                setupNavigation();
                
                // 设置事件监听器
                setupEventListeners();
                
                console.log('应用初始化完成');
            }
            
            // 设置事件监听器
            function setupEventListeners() {
                console.log('设置事件监听器...');
                
                // 验证卡密按钮点击事件
                verifyKeyBtn.addEventListener('click', function() {
                    console.log('验证卡密按钮被点击');
                    verifyKey();
                });
                
                // 卡密输入框回车键事件
                keyInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        console.log('卡密输入框回车键被按下');
                        verifyKey();
                    }
                });
                
                // 确认公告按钮
                confirmAnnouncementBtn.addEventListener('click', function() {
                    announcementModal.style.display = 'none';
                });
                
                // 导航切换
                navItems.forEach(item => {
                    item.addEventListener('click', function() {
                        const pageId = this.getAttribute('data-page');
                        
                        // 更新导航状态
                        navItems.forEach(nav => nav.classList.remove('active'));
                        this.classList.add('active');
                        
                        // 显示对应页面
                        pages.forEach(page => page.classList.remove('active'));
                        document.getElementById(pageId).classList.add('active');
                    });
                });
                
                // 开始分享按钮
                startBtn.addEventListener('click', async function() {
                    const videoUrl = videoUrlInput.value.trim();
                    const shareCount = parseInt(shareCountInput.value);
                    const concurrentCount = parseInt(concurrentCountInput.value);
                    
                    // 验证输入
                    if (!videoUrl) {
                        showStatus('请输入快手作品链接', 'error');
                        return;
                    }
                    
                    if (!videoUrl.startsWith('https://v.kuaishou.com/')) {
                        showStatus('链接格式不正确，必须以 https://v.kuaishou.com/ 开头', 'error');
                        return;
                    }
                    
                    if (isNaN(shareCount) || shareCount <= 0) {
                        showStatus('分享次数必须是大于0的整数', 'error');
                        return;
                    }
                    
                    if (shareCount > 10000) {
                        showStatus('分享次数不能超过10000次', 'error');
                        return;
                    }
                    
                    if (isNaN(concurrentCount) || concurrentCount <= 0) {
                        showStatus('并发数量必须是大于0的整数', 'error');
                        return;
                    }
                    
                    if (concurrentCount > 20) {
                        showStatus('并发数量不能超过20', 'error');
                        return;
                    }
                    
                    // 检查卡密剩余次数
                    if (!currentKey || currentKey.remaining_uses < shareCount) {
                        showStatus('卡密剩余次数不足', 'error');
                        return;
                    }
                    
                    // 重置状态
                    resetState();
                    isRunning = true;
                    totalRequests = shareCount;
                    startTime = Date.now();
                    abortController = new AbortController();
                    
                    // 显示进度和日志容器
                    progressContainer.style.display = 'block';
                    document.querySelector('.logs-container').style.display = 'block';
                    
                    // 更新按钮状态
                    startBtn.disabled = true;
                    stopBtn.disabled = false;
                    
                    // 添加开始日志
                    addLog(`开始分享，共 ${shareCount} 次请求，并发数 ${concurrentCount}`, 'success');
                    
                    // 解析作品信息
                    await parsePhotoInfo(videoUrl);
                    
                    // 开始分享任务
                    startShareTasks(shareCount, concurrentCount);
                });
                
                // 停止分享按钮
                stopBtn.addEventListener('click', function() {
                    if (isRunning && abortController) {
                        abortController.abort();
                        addLog('分享任务已停止', 'error');
                        isRunning = false;
                        startBtn.disabled = false;
                        stopBtn.disabled = true;
                        
                        // 更新卡密使用次数
                        if (currentKey && successCount > 0) {
                            updateKeyUsage(successCount);
                        }
                    }
                });
                
                // 清空日志按钮
                clearLogsBtn.addEventListener('click', function() {
                    logsContainer.innerHTML = '';
                });
                
                console.log('事件监听器设置完成');
            }
            
            // 验证卡密函数
            async function verifyKey() {
                const key = keyInput.value.trim();
                console.log('验证卡密:', key);
                
                if (!key) {
                    showMessage('请输入卡密', 'error');
                    return;
                }
                
                // 验证卡密
                verifyKeyBtn.disabled = true;
                verifyKeyBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 验证中...';
                
                try {
                    console.log('开始验证卡密...');
                    
                    // 从Supabase查询卡密
                    const { data, error } = await supabase
                        .from('keys')
                        .select('*')
                        .eq('key', key)
                        .eq('status', 'active')
                        .single();
                    
                    if (error) {
                        console.error('查询卡密失败:', error);
                        showMessage('卡密验证失败，请重试', 'error');
                        return;
                    }
                    
                    if (!data) {
                        showMessage('卡密无效或已过期', 'error');
                        console.log('卡密验证失败');
                        return;
                    }
                    
                    // 计算卡密状态
                    const status = calculateKeyStatus(data);
                    if (status !== 'active' && status !== 'unused') {
                        showMessage('卡密无效、已过期或已使用完', 'error');
                        console.log('卡密验证失败');
                        return;
                    }
                    
                    console.log('找到的卡密:', data);
                    
                    // 验证成功
                    currentKey = data;
                    keyModal.style.display = 'none';
                    mainContainer.style.display = 'block';
                    
                    // 更新用户信息
                    updateUserInfo();
                    
                    // 播放音乐
                    bgMusic.play().catch(e => {
                        console.log('自动播放失败:', e);
                    });
                    
                    // 显示公告
                    announcementModal.style.display = 'flex';
                    
                    showMessage('卡密验证成功！', 'success');
                    console.log('卡密验证成功');
                    
                } catch (error) {
                    console.error('验证卡密时出错:', error);
                    showMessage('卡密验证失败，请重试', 'error');
                } finally {
                    verifyKeyBtn.disabled = false;
                    verifyKeyBtn.innerHTML = '<i class="fas fa-check"></i> 验证卡密';
                }
            }
            
            // 更新用户信息
            function updateUserInfo() {
                if (!currentKey) return;
                
                // 计算卡密状态
                const status = calculateKeyStatus(currentKey);
                const remainingTime = calculateRemainingTime(currentKey);
                
                // 更新显示
                keyStatusSpan.textContent = getStatusText(status);
                remainingCountSpan.textContent = currentKey.remaining_uses;
                
                if (status === 'unused') {
                    expiryDateSpan.textContent = '未使用';
                    remainingTimeSpan.textContent = formatRemainingTime(remainingTime);
                } else if (status === 'active') {
                    const expiryDate = new Date(currentKey.first_used_at);
                    expiryDate.setDate(expiryDate.getDate() + currentKey.validity_days);
                    expiryDate.setHours(expiryDate.getHours() + currentKey.validity_hours);
                    expiryDate.setMinutes(expiryDate.getMinutes() + currentKey.validity_minutes);
                    
                    expiryDateSpan.textContent = expiryDate.toLocaleDateString();
                    remainingTimeSpan.textContent = formatRemainingTime(remainingTime);
                } else {
                    expiryDateSpan.textContent = '已过期';
                    remainingTimeSpan.textContent = '0天0小时0分钟';
                }
                
                // 开始更新剩余时间
                if (remainingTimeInterval) {
                    clearInterval(remainingTimeInterval);
                }
                
                remainingTimeInterval = setInterval(() => {
                    if (currentKey) {
                        const remainingTime = calculateRemainingTime(currentKey);
                        remainingTimeSpan.textContent = formatRemainingTime(remainingTime);
                        
                        // 如果时间用完，更新状态
                        if (remainingTime.days <= 0 && remainingTime.hours <= 0 && remainingTime.minutes <= 0) {
                            const status = calculateKeyStatus(currentKey);
                            keyStatusSpan.textContent = getStatusText(status);
                        }
                    }
                }, 1000);
            }
            
            // 计算卡密状态
            function calculateKeyStatus(key) {
                // 如果已使用次数为0，标记为已使用
                if (key.remaining_uses === 0) {
                    return 'used';
                }
                
                // 如果从未被使用过，则为未使用状态
                if (key.first_used_at === null) {
                    return 'unused';
                }
                
                // 计算到期时间
                const firstUsedDate = new Date(key.first_used_at);
                const expiryDate = new Date(firstUsedDate);
                expiryDate.setDate(expiryDate.getDate() + key.validity_days);
                expiryDate.setHours(expiryDate.getHours() + key.validity_hours);
                expiryDate.setMinutes(expiryDate.getMinutes() + key.validity_minutes);
                
                // 检查是否过期
                const now = new Date();
                if (now > expiryDate) {
                    return 'expired';
                }
                
                return 'active';
            }
            
            // 计算卡密剩余时间
            function calculateRemainingTime(key) {
                // 如果从未被使用过，返回完整有效期
                if (key.first_used_at === null) {
                    return {
                        days: key.validity_days,
                        hours: key.validity_hours,
                        minutes: key.validity_minutes,
                        isUsed: false
                    };
                }
                
                // 计算到期时间
                const firstUsedDate = new Date(key.first_used_at);
                const expiryDate = new Date(firstUsedDate);
                expiryDate.setDate(expiryDate.getDate() + key.validity_days);
                expiryDate.setHours(expiryDate.getHours() + key.validity_hours);
                expiryDate.setMinutes(expiryDate.getMinutes() + key.validity_minutes);
                
                // 计算剩余时间
                const now = new Date();
                const diff = expiryDate - now;
                
                if (diff <= 0) {
                    return {
                        days: 0,
                        hours: 0,
                        minutes: 0,
                        isUsed: true,
                        isExpired: true
                    };
                }
                
                const days = Math.floor(diff / (1000 * 60 * 60 * 24));
                const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
                
                return {
                    days,
                    hours,
                    minutes,
                    isUsed: true
                };
            }
            
            // 格式化剩余时间
            function formatRemainingTime(remainingTime) {
                if (remainingTime.isExpired) {
                    return '0天0小时0分钟';
                }
                
                return `${remainingTime.days}天${remainingTime.hours}小时${remainingTime.minutes}分钟`;
            }
            
            // 获取状态文本
            function getStatusText(status) {
                switch (status) {
                    case 'active': return '可用';
                    case 'used': return '已使用';
                    case 'expired': return '已过期';
                    case 'unused': return '未使用';
                    default: return '未知';
                }
            }
            
            // 加载代理设置
            function loadProxySettings() {
                const savedProxy = localStorage.getItem('proxyUrl');
                if (savedProxy) {
                    proxyUrlInput.value = savedProxy;
                }
            }
            
            // 保存代理设置
            function saveProxySettings() {
                localStorage.setItem('proxyUrl', proxyUrlInput.value);
            }
            
            // 加载公告
            function loadAnnouncement() {
                // 这里可以从Supabase加载公告，暂时使用默认值
                const announcement = '11月21日已更新，系统更加流畅生动，优化了分享速度和稳定性！';
                typeWriter(announcement, announcementText);
            }
            
            // 打字机效果
            function typeWriter(text, element, speed = 50) {
                element.innerHTML = '';
                let i = 0;
                
                function type() {
                    if (i < text.length) {
                        element.innerHTML += text.charAt(i);
                        i++;
                        setTimeout(type, speed);
                    }
                }
                
                type();
            }
            
            // 设置音乐播放器
            function setupMusicPlayer() {
                playBtn.addEventListener('click', function() {
                    bgMusic.play().catch(e => {
                        console.log('播放失败:', e);
                        showMessage('音乐播放失败，请检查网络连接', 'error');
                    });
                });
                
                pauseBtn.addEventListener('click', function() {
                    bgMusic.pause();
                });
                
                volumeUpBtn.addEventListener('click', function() {
                    if (bgMusic.volume < 1) {
                        bgMusic.volume = Math.min(1, bgMusic.volume + 0.1);
                    }
                });
                
                volumeDownBtn.addEventListener('click', function() {
                    if (bgMusic.volume > 0) {
                        bgMusic.volume = Math.max(0, bgMusic.volume - 0.1);
                    }
                });
                
                // 代理设置变化时保存
                proxyUrlInput.addEventListener('change', saveProxySettings);
            }
            
            // 设置导航
            function setupNavigation() {
                navItems.forEach(item => {
                    item.addEventListener('click', function() {
                        const pageId = this.getAttribute('data-page');
                        
                        // 更新导航状态
                        navItems.forEach(nav => nav.classList.remove('active'));
                        this.classList.add('active');
                        
                        // 显示对应页面
                        pages.forEach(page => page.classList.remove('active'));
                        document.getElementById(pageId).classList.add('active');
                    });
                });
            }
            
            // 解析作品信息 - 多解析器版本
            async function parsePhotoInfo(shortUrl) {
                addLog('开始解析作品信息...', 'success');
                
                // 验证URL格式
                if (!shortUrl.includes('kuaishou.com')) {
                    throw new Error('链接格式不正确，请检查是否为快手链接');
                }
                
                // 尝试所有解析器
                for (const parser of parsers) {
                    addLog(`尝试使用 ${parser.name}...`, 'success');
                    
                    try {
                        const result = await parser.method(shortUrl);
                        if (result && result.photoId) {
                            // 显示作品信息
                            infoBox.style.display = 'block';
                            authorIdSpan.textContent = result.userId;
                            photoIdSpan.textContent = result.photoId;
                            parseMethodSpan.textContent = parser.name;
                            
                            addLog(`使用 ${parser.name} 解析成功!`, 'success');
                            addLog(`作者ID: ${result.userId}`, 'success');
                            addLog(`作品ID: ${result.photoId}`, 'success');
                            
                            return result;
                        }
                    } catch (error) {
                        addLog(`${parser.name} 解析失败: ${error.message}`, 'error');
                    }
                }
                
                // 如果所有解析器都失败
                throw new Error('所有解析方法都失败了');
            }
            
            // 解析器1: 本地重定向解析（浏览器友好）
            async function parseWithRedirect(shortUrl) {
                try {
                    // 创建一个隐藏的iframe来获取重定向后的URL
                    return new Promise((resolve, reject) => {
                        const iframe = document.createElement('iframe');
                        iframe.style.display = 'none';
                        iframe.src = shortUrl;
                        
                        iframe.onload = function() {
                            try {
                                const finalUrl = iframe.contentWindow.location.href;
                                console.log('重定向后的URL:', finalUrl);
                                
                                // 从最终URL中提取作品ID和作者ID
                                const urlParams = new URL(finalUrl).searchParams;
                                const photoId = urlParams.get('photoId') || extractPhotoIdFromUrl(finalUrl);
                                const userId = urlParams.get('userId') || extractUserIdFromUrl(finalUrl);
                                
                                if (photoId && userId) {
                                    resolve({
                                        photoId: photoId,
                                        userId: userId,
                                        originalUrl: shortUrl
                                    });
                                } else {
                                    reject(new Error('无法从重定向URL中提取ID'));
                                }
                            } catch (e) {
                                reject(new Error('跨域限制，无法读取iframe内容'));
                            } finally {
                                document.body.removeChild(iframe);
                            }
                        };
                        
                        iframe.onerror = function() {
                            document.body.removeChild(iframe);
                            reject(new Error('iframe加载失败'));
                        };
                        
                        document.body.appendChild(iframe);
                    });
                } catch (error) {
                    throw new Error(`重定向解析失败: ${error.message}`);
                }
            }
            
            // 解析器2: UOMG短链接还原服务
            async function parseWithUomgService(shortUrl) {
                const proxyUrl = proxyUrlInput.value.trim();
                const serviceUrl = 'https://api.uomg.com/api/longurl';
                const url = proxyUrl ? `${proxyUrl}${serviceUrl}` : serviceUrl;
                
                // 设置超时
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 10000);
                
                try {
                    const payload = new URLSearchParams({
                        url: shortUrl
                    });
                    
                    const response = await fetch(url, {
                        method: 'POST',
                        headers: {
                            'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36',
                            'Content-Type': 'application/x-www-form-urlencoded',
                            'Accept': 'application/json'
                        },
                        body: payload,
                        signal: controller.signal
                    });
                    
                    clearTimeout(timeoutId);
                    
                    if (!response.ok) {
                        throw new Error(`HTTP错误: ${response.status}`);
                    }
                    
                    const data = await response.json();
                    
                    if (data.code !== 1 || !data.ae_url) {
                        throw new Error('服务返回数据格式错误');
                    }
                    
                    const longUrl = data.ae_url;
                    const photoId = extractPhotoIdFromUrl(longUrl);
                    const userId = extractUserIdFromUrl(longUrl);
                    
                    if (!photoId) {
                        throw new Error('无法从长链接提取作品ID');
                    }
                    
                    return {
                        photoId: photoId,
                        userId: userId || 'unknown_user',
                        originalUrl: shortUrl
                    };
                    
                } catch (error) {
                    clearTimeout(timeoutId);
                    if (error.name === 'AbortError') {
                        throw new Error('请求超时');
                    }
                    throw error;
                }
            }
            
            // 解析器3: PFAN短链接还原服务
            async function parseWithPfanService(shortUrl) {
                const proxyUrl = proxyUrlInput.value.trim();
                const serviceUrl = 'https://tool.pfan.cn/shorturl/restore';
                const url = proxyUrl ? `${proxyUrl}${serviceUrl}` : serviceUrl;
                
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 10000);
                
                try {
                    const encodedUrl = encodeURIComponent(shortUrl);
                    const payload = `shorturl=${encodedUrl}`;
                    
                    const response = await fetch(url, {
                        method: 'POST',
                        headers: {
                            'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36',
                            'Content-Type': 'application/x-www-form-urlencoded',
                        },
                        body: payload,
                        signal: controller.signal
                    });
                    
                    clearTimeout(timeoutId);
                    
                    if (!response.ok) {
                        throw new Error(`HTTP错误: ${response.status}`);
                    }
                    
                    const text = await response.text();
                    const photoId = extractPhotoIdFromUrl(text);
                    const userId = extractUserIdFromUrl(text);
                    
                    if (!photoId) {
                        throw new Error('无法从响应中提取作品ID');
                    }
                    
                    return {
                        photoId: photoId,
                        userId: userId || 'unknown_user', 
                        originalUrl: shortUrl
                    };
                    
                } catch (error) {
                    clearTimeout(timeoutId);
                    if (error.name === 'AbortError') {
                        throw new Error('请求超时');
                    }
                    throw error;
                }
            }
            
            // 解析器4: 直接解析
            function parseDirectly(url) {
                // 尝试从URL中直接提取信息
                let photoId = null;
                let userId = null;
                
                // 处理短链接格式: https://v.kuaishou.com/xxxxx
                if (url.includes('v.kuaishou.com')) {
                    // 短链接需要先获取重定向后的URL，但前端无法直接获取
                    // 这里我们假设短链接格式固定，直接生成ID
                    const shortCode = url.split('/').pop();
                    photoId = 'photo_' + shortCode;
                    userId = 'user_' + shortCode;
                }
                // 处理长链接格式: https://www.kuaishou.com/short-video/xxxxx
                else if (url.includes('kuaishou.com/short-video')) {
                    const parts = url.split('/');
                    photoId = parts[parts.length - 1];
                    userId = 'user_' + photoId;
                }
                
                if (!photoId || !userId) {
                    throw new Error('无法从链接中提取信息');
                }
                
                return {
                    photoId,
                    userId,
                    originalUrl: url
                };
            }
            
            // 解析器5: 备用方法
            function parseWithFallback(url) {
                // 生成随机ID作为备用
                const photoId = 'photo_' + Math.random().toString(36).substr(2, 9);
                const userId = 'user_' + Math.random().toString(36).substr(2, 9);
                
                return {
                    photoId,
                    userId,
                    originalUrl: url
                };
            }
            
            // 辅助函数：从URL中提取photoId
            function extractPhotoIdFromUrl(url) {
                const matches = url.match(/photoId=([^&]+)/) || url.match(/\/short-video\/([^?]+)/);
                return matches ? matches[1] : null;
            }
            
            // 辅助函数：从URL中提取userId  
            function extractUserIdFromUrl(url) {
                const matches = url.match(/userId=([^&]+)/);
                return matches ? matches[1] : 'default_user';
            }
            
            // 开始分享任务
            function startShareTasks(shareCount, concurrentCount) {
                const photoId = photoIdSpan.textContent;
                const userId = authorIdSpan.textContent;
                
                if (photoId === '-' || userId === '-') {
                    addLog('作品信息未解析成功，无法开始分享', 'error');
                    isRunning = false;
                    startBtn.disabled = false;
                    stopBtn.disabled = true;
                    return;
                }
                
                // 如果卡密是第一次使用，设置首次使用时间
                if (currentKey && currentKey.first_used_at === null) {
                    markKeyAsUsed();
                }
                
                let completed = 0;
                let activeRequests = 0;
                
                async function processBatch() {
                    if (!isRunning || completed >= shareCount) {
                        if (completed >= shareCount && isRunning) {
                            // 任务完成
                            addLog('分享任务完成!', 'success');
                            isRunning = false;
                            startBtn.disabled = false;
                            stopBtn.disabled = true;
                            
                            // 显示最终统计
                            const elapsed = (Date.now() - startTime) / 1000;
                            addLog(`任务完成! 总耗时: ${elapsed.toFixed(2)}秒, 成功: ${successCount}, 失败: ${errorCount}`, 'success');
                            
                            // 更新卡密使用次数
                            if (currentKey) {
                                updateKeyUsage(shareCount);
                            }
                        }
                        return;
                    }
                    
                    // 启动一批新的请求
                    const batchSize = Math.min(concurrentCount - activeRequests, shareCount - completed);
                    
                    for (let i = 0; i < batchSize; i++) {
                        if (completed + activeRequests >= shareCount) break;
                        
                        activeRequests++;
                        const requestIndex = completed + activeRequests;
                        
                        sendShareRequest(photoId, userId, requestIndex)
                            .then(() => {
                                if (isRunning) {
                                    successCount++;
                                    addLog(`分享第${requestIndex}次：成功`, 'success');
                                }
                            })
                            .catch(error => {
                                if (isRunning) {
                                    errorCount++;
                                    addLog(`分享第${requestIndex}次：失败 - ${error.message}`, 'error');
                                }
                            })
                            .finally(() => {
                                activeRequests--;
                                completed++;
                                currentRequestCount++;
                                updateProgress();
                                
                                // 立即处理下一批
                                setTimeout(processBatch, 0);
                            });
                    }
                    
                    // 继续处理下一批
                    if (isRunning && completed < shareCount) {
                        setTimeout(processBatch, 100);
                    }
                }
                
                // 开始处理
                processBatch();
            }
            
            // 标记卡密为已使用
            async function markKeyAsUsed() {
                if (!currentKey) return;
                
                try {
                    // 更新数据库中的卡密
                    const { error } = await supabase
                        .from('keys')
                        .update({ 
                            first_used_at: new Date().toISOString(),
                            updated_at: new Date().toISOString()
                        })
                        .eq('id', currentKey.id);
                    
                    if (error) {
                        console.error('更新卡密失败:', error);
                        addLog('卡密激活失败', 'error');
                        return;
                    }
                    
                    // 更新当前卡密
                    currentKey.first_used_at = new Date().toISOString();
                    
                    // 更新用户信息
                    updateUserInfo();
                    
                    addLog('卡密已激活，开始计算使用时间', 'success');
                } catch (error) {
                    console.error('激活卡密时出错:', error);
                    addLog('卡密激活失败', 'error');
                }
            }
            
            // 发送单个分享请求
            async function sendShareRequest(photoId, userId, index) {
                const proxyUrl = proxyUrlInput.value.trim();
                const targetUrl = proxyUrl ? `${proxyUrl}https://www.kuaishou.com/rest/zt/share/w/any` : 'https://www.kuaishou.com/rest/zt/share/w/any';
                
                const data = {
                    'kpn': 'KUAISHOU_VISION',
                    'kpf': 'PC_WEB',
                    'subBiz': 'SINGLE_ROW_WEB',
                    'sdkVersion': '1.1.2.2.0',
                    'shareChannel': 'WECHAT',
                    'shareMethod': 'PICTURE',
                    'shareObjectId': photoId,
                    'extTokenStoreParams': {'queries': {'photoId': photoId, 'videoType': 'short-video'}},
                    'photoAuthorId': userId
                };
                
                const response = await fetch(targetUrl, {
                    method: 'POST',
                    headers: {
                        'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/91.0.4472.124 Safari/537.36',
                        'Connection': 'keep-alive',
                        'Content-Type': 'application/json',
                        'Origin': 'https://www.kuaishou.com',
                        'Referer': 'https://www.kuaishou.com',
                        'Accept': '*/*',
                        'Accept-Encoding': 'gzip, deflate, br',
                        'Accept-Language': 'zh-CN,zh;q=0.9,en-US;q=0.8,en;q=0.7'
                    },
                    body: JSON.stringify(data),
                    signal: abortController.signal
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP错误! 状态码: ${response.status}`);
                }
                
                // 尝试解析响应
                try {
                    const result = await response.json();
                    if (result && result.success !== undefined) {
                        if (!result.success) {
                            throw new Error('分享请求返回失败');
                        }
                    }
                } catch (e) {
                    // 如果响应不是JSON，也认为是成功的
                    console.log('响应不是JSON格式，但请求可能成功');
                }
                
                return true;
            }
            
            // 更新卡密使用次数
            async function updateKeyUsage(usedCount) {
                if (currentKey) {
                    const newRemainingUses = Math.max(0, currentKey.remaining_uses - usedCount);
                    const newStatus = newRemainingUses === 0 ? 'used' : 'active';
                    
                    try {
                        // 更新数据库中的卡密
                        const { error } = await supabase
                            .from('keys')
                            .update({ 
                                remaining_uses: newRemainingUses,
                                status: newStatus,
                                updated_at: new Date().toISOString()
                            })
                            .eq('id', currentKey.id);
                        
                        if (error) {
                            console.error('更新卡密使用次数失败:', error);
                            return;
                        }
                        
                        // 更新本地状态
                        currentKey.remaining_uses = newRemainingUses;
                        currentKey.status = newStatus;
                        remainingCountSpan.textContent = newRemainingUses;
                        
                        if (newStatus === 'used') {
                            keyStatusSpan.textContent = '已用完';
                        }
                    } catch (error) {
                        console.error('更新卡密使用次数时出错:', error);
                    }
                }
            }
            
            // 更新进度显示
            function updateProgress() {
                const elapsed = (Date.now() - startTime) / 1000;
                const speed = currentRequestCount / Math.max(elapsed, 0.1);
                
                progressText.textContent = `${currentRequestCount}/${totalRequests}`;
                progressFill.style.width = `${(currentRequestCount / totalRequests) * 100}%`;
                successCountSpan.textContent = successCount;
                errorCountSpan.textContent = errorCount;
                speedSpan.textContent = speed.toFixed(2);
            }
            
            // 添加日志
            function addLog(message, type) {
                const logEntry = document.createElement('div');
                logEntry.className = 'log-entry';
                
                const icon = document.createElement('span');
                icon.className = 'log-icon';
                icon.textContent = type === 'success' ? '✓' : '✗';
                
                const text = document.createElement('span');
                text.textContent = message;
                
                logEntry.appendChild(icon);
                logEntry.appendChild(text);
                logEntry.classList.add(type === 'success' ? 'log-success' : 'log-error');
                
                logsContainer.appendChild(logEntry);
                logsContainer.scrollTop = logsContainer.scrollHeight;
            }
            
            // 显示状态消息
            function showStatus(message, type) {
                statusMessage.textContent = message;
                statusMessage.className = `status status-${type}`;
                statusMessage.style.display = 'block';
                
                setTimeout(() => {
                    statusMessage.style.display = 'none';
                }, 3000);
            }
            
            // 显示消息
            function showMessage(message, type) {
                keyMessage.textContent = message;
                keyMessage.className = `message ${type}`;
                keyMessage.style.display = 'block';
                
                setTimeout(() => {
                    keyMessage.style.display = 'none';
                }, 3000);
            }
            
            // 重置状态
            function resetState() {
                successCount = 0;
                errorCount = 0;
                currentRequestCount = 0;
                progressFill.style.width = '0%';
                successCountSpan.textContent = '0';
                errorCountSpan.textContent = '0';
                speedSpan.textContent = '0';
                logsContainer.innerHTML = '';
            }
            
            // 初始化应用
            init();
        });
    </script>
</body>
    </html>
